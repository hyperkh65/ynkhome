<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YNK INTELLIGENT ERP</title>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Modern ERP CSS -->
<link rel="stylesheet" href="css/modern-erp.css">
<!-- SheetJS for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  /* Compatibility layer for legacy components */
  .tab-btn {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .shadow-premium {
    box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.04), 0 4px 10px -5px rgba(0, 0, 0, 0.02);
  }
</style>
</head>

<body class="bg-gray-50 text-gray-900">

  <header>
    <div class="max-w-[1600px] mx-auto px-6 h-20 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div
          class="w-10 h-10 rounded-[14px] bg-[#0f172a] text-white flex items-center justify-center font-black shadow-lg">
          YNK</div>
        <div>
          <h1 class="text-base font-bold tracking-tight text-slate-900 leading-none">INTELLIGENT ERP</h1>
          <span class="text-[11px] font-semibold text-emerald-600 uppercase tracking-widest mt-1 block">Global Trading
            Hub</span>
        </div>
      </div>
      <div id="userBadge" class="hidden items-center gap-6">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
          <span id="userName" class="text-sm font-semibold text-slate-700"></span>
        </div>
        <button id="btnLogout"
          class="text-xs font-bold text-slate-400 hover:text-red-500 transition-colors uppercase tracking-widest">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-[1600px] mx-auto px-6 py-8">
    <!-- ë¡œê·¸ì¸ (ì´ˆê¸° ì•ˆì •í™” ë²„ì „ ë³µêµ¬) -->
    <section id="authPanel" class="fixed inset-0 z-[9999] flex items-center justify-center bg-gray-100">
      <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm border border-gray-200">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800 tracking-tight">YNK ERP ë¡œê·¸ì¸</h2>
        <form id="loginForm" class="space-y-5">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">ì´ë©”ì¼</label>
            <input id="loginEmail" type="email" required
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
              placeholder="admin@ynk2014.com" />
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
            <input id="loginPassword" type="password" required
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
          <button type="submit"
            class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition shadow-md">
            ë¡œê·¸ì¸
          </button>
          <div id="loginMsg" class="text-sm text-red-500 text-center hidden mt-2 bg-red-50 py-2 rounded">
            ì¸ì¦ ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </div>
        </form>
        <p class="text-xs text-center text-gray-400 mt-6 font-medium">YNK INTEGRATED SYSTEM</p>
      </div>
    </section>

    <!-- ì•± ë©”ì¸ íŒ¨ë„ -->
    <section id="appPanel" class="hidden">
      <div class="tab-container no-scrollbar flex gap-2 overflow-x-auto pb-2 border-b border-slate-200 mb-6">
        <button data-tab="dashboard" class="tab-btn active whitespace-nowrap">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
        <button data-tab="sales-search" class="tab-btn whitespace-nowrap">ğŸ“ˆ ë§¤ì¶œ ì¡°íšŒ</button>
        <button data-tab="sales-entry" class="tab-btn whitespace-nowrap">ğŸ’° ë§¤ì¶œ ë“±ë¡</button>
        <button data-tab="products-entry" class="tab-btn whitespace-nowrap">ğŸ“¦ í’ˆëª© ê´€ë¦¬</button>
        <button data-tab="clients" class="tab-btn whitespace-nowrap">ğŸ¢ ê±°ë˜ì²˜</button>
        <button data-tab="quotes-search" class="tab-btn whitespace-nowrap">ğŸ“‹ ê²¬ì  ë‚´ì—­</button>
        <button data-tab="quotes" class="tab-btn whitespace-nowrap">ğŸ“„ ê²¬ì  ì‘ì„±</button>
        <button data-tab="po-search" class="tab-btn whitespace-nowrap">ğŸ“‘ ë°œì£¼ ë‚´ì—­</button>
        <button data-tab="po-entry" class="tab-btn whitespace-nowrap">ğŸ›’ ë°œì£¼ ë“±ë¡</button>
        <button data-tab="import-entry" class="tab-btn whitespace-nowrap">ğŸŒ ìˆ˜ì… ê´€ë¦¬</button>
      </div>

      <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
      <div id="tab-dashboard" class="tab">
        <div class="space-y-8">

          <!-- KPI ì¹´ë“œ ê·¸ë¦¬ë“œ -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

            <!-- ì´ë²ˆë‹¬ ë§¤ì¶œ -->
            <div
              class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm hover:border-blue-400 hover:shadow-md transition-all duration-300">
              <div class="flex justify-between items-start mb-3">
                <div
                  class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-lg">
                  ğŸ’°</div>
                <span class="text-[11px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md">ë§¤ì¶œ</span>
              </div>
              <div class="text-xs font-medium text-slate-500 mb-1">ì´ë²ˆ ë‹¬ ë§¤ì¶œì•¡</div>
              <div id="dashSales" class="text-2xl font-extrabold text-slate-900 tracking-tight">0</div>
              <div id="dashSalesDetail" class="text-[11px] text-slate-400 mt-1">ì§‘ê³„ ì¤‘...</div>
            </div>

            <!-- ì´ë²ˆë‹¬ ë°œì£¼ -->
            <div
              class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm hover:border-purple-400 hover:shadow-md transition-all duration-300">
              <div class="flex justify-between items-start mb-3">
                <div
                  class="w-10 h-10 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center font-bold text-lg">
                  ğŸ“¦</div>
                <span class="text-[11px] font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded-md">ë°œì£¼</span>
              </div>
              <div class="text-xs font-medium text-slate-500 mb-1">ì´ë²ˆ ë‹¬ ë°œì£¼ì•¡</div>
              <div id="dashPo" class="text-2xl font-extrabold text-slate-900 tracking-tight">0</div>
              <div id="dashPoDetail" class="text-[11px] text-slate-400 mt-1">ì§‘ê³„ ì¤‘...</div>
            </div>

            <!-- ê±°ë˜ì²˜ ìˆ˜ -->
            <div
              class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm hover:border-emerald-400 hover:shadow-md transition-all duration-300">
              <div class="flex justify-between items-start mb-3">
                <div
                  class="w-10 h-10 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center font-bold text-lg">
                  ğŸ¢</div>
                <span class="text-[11px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md">ë„¤íŠ¸ì›Œí¬</span>
              </div>
              <div class="text-xs font-medium text-slate-500 mb-1">ì´ ê±°ë˜ì²˜ ìˆ˜</div>
              <div id="dashClients" class="text-2xl font-extrabold text-slate-900 tracking-tight">0</div>
              <div class="text-[11px] text-slate-400 mt-1">ë“±ë¡ëœ íŒŒíŠ¸ë„ˆì‚¬</div>
            </div>

            <!-- CBM ê³„ì‚°ê¸° (Quick Link) -->
            <a href="cbm.html" target="_blank"
              class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm hover:border-orange-400 hover:shadow-md transition-all duration-300 group cursor-pointer">
              <div class="flex justify-between items-start mb-3">
                <div
                  class="w-10 h-10 rounded-xl bg-orange-50 text-orange-600 flex items-center justify-center font-bold text-lg">
                  ğŸ“</div>
                <span class="text-[11px] font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-md">ë„êµ¬</span>
              </div>
              <div class="text-xs font-medium text-slate-500 mb-1">ë¬¼ë¥˜ ë„êµ¬</div>
              <div class="text-lg font-bold text-slate-900 group-hover:text-orange-600 transition-colors">CBM ê³„ì‚°ê¸°</div>
              <div class="text-[11px] text-orange-500 mt-1 font-semibold flex items-center">ì—´ê¸° <span
                  class="ml-1">â†’</span></div>
            </a>
          </div>

          <!-- ì°¨íŠ¸ ì˜ì—­ -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- í™˜ìœ¨ ì°¨íŠ¸ -->
            <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between mb-6">
                <h4 class="font-bold text-slate-800 flex items-center gap-2">
                  <span class="w-1.5 h-5 bg-emerald-500 rounded-full"></span>
                  í™˜ìœ¨ ë³€ë™ ì¶”ì´
                </h4>
                <div class="flex gap-2">
                  <select id="fxCurrency"
                    class="text-xs font-semibold bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 focus:border-emerald-500 focus:ring-emerald-500 outline-none">
                    <option value="USDKRW">USD/KRW</option>
                    <option value="JPYKRW">JPY/KRW</option>
                    <option value="EURKRW">EUR/KRW</option>
                    <option value="CNYKRW">CNY/KRW</option>
                  </select>
                  <select id="fxPeriod"
                    class="text-xs font-semibold bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 focus:border-emerald-500 focus:ring-emerald-500 outline-none">
                    <option value="3">3ê°œì›”</option>
                    <option value="6">6ê°œì›”</option>
                    <option value="12" selected>12ê°œì›”</option>
                  </select>
                </div>
              </div>
              <div class="h-[300px]">
                <canvas id="chartFx" style="width:100%; height:100%"></canvas>
              </div>
            </div>

            <!-- LME ì°¨íŠ¸ -->
            <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between mb-6">
                <h4 class="font-bold text-slate-800 flex items-center gap-2">
                  <span class="w-1.5 h-5 bg-blue-500 rounded-full"></span>
                  LME ì›ìì¬ ì‹œì„¸
                </h4>
                <div class="flex gap-2">
                  <select id="lmeMetal"
                    class="text-xs font-semibold bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 focus:border-blue-500 focus:ring-blue-500 outline-none">
                    <option value="copper">êµ¬ë¦¬ (Copper)</option>
                    <option value="aluminum">ì•Œë£¨ë¯¸ëŠ„ (Aluminum)</option>
                    <option value="nickel">ë‹ˆì¼ˆ (Nickel)</option>
                    <option value="zinc">ì•„ì—° (Zinc)</option>
                  </select>
                  <select id="lmePeriod"
                    class="text-xs font-semibold bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 focus:border-blue-500 focus:ring-blue-500 outline-none">
                    <option value="1">1ê°œì›”</option>
                    <option value="3" selected>3ê°œì›”</option>
                    <option value="6">6ê°œì›”</option>
                  </select>
                </div>
              </div>
              <div class="h-[300px]">
                <canvas id="chartLME" style="width:100%; height:100%"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
      </div>

      <!-- ë§¤ì¶œ ì…ë ¥ -->
      <div id="tab-sales-entry" class="tab hidden">
        <div class="premium-card shadow-premium space-y-8">
          <div class="flex justify-between items-end">
            <div>
              <h3 class="font-bold text-xl text-slate-900">New Sales Transaction</h3>
              <p class="text-sm text-slate-500 mt-1">Register a new sales record in the Notion database</p>
            </div>
            <div class="text-right">
              <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Transaction
                ID</span>
              <span id="saleCodeEl"
                class="text-lg font-black text-emerald-600 font-mono tracking-tighter">AUTOMATIC</span>
            </div>
          </div>

          <div class="grid md:grid-cols-4 gap-6 p-6 bg-slate-50 rounded-2xl border border-slate-100">
            <div class="space-y-1.5">
              <label class="text-[12px] font-bold text-slate-700 ml-1">Client Partner</label>
              <div class="flex gap-2">
                <input id="saleCustomer" class="w-full bg-white font-semibold text-slate-700"
                  placeholder="Choose Client" readonly />
                <button type="button" id="btnPickClient"
                  class="px-3 py-2 bg-slate-200 rounded-xl hover:bg-slate-300 transition-colors">ğŸ“‚</button>
              </div>
            </div>
            <div class="space-y-1.5">
              <label class="text-[12px] font-bold text-slate-700 ml-1">Sales Classification</label>
              <select id="saleType" class="w-full bg-white font-semibold">
                <option value="ë‚´ì" selected>Internal (KR)</option>
                <option value="ì™¸ì">Export/Global</option>
              </select>
            </div>
            <div class="space-y-1.5 flex gap-4">
              <div class="w-1/2 space-y-1.5">
                <label class="text-[12px] font-bold text-slate-700 ml-1">Currency</label>
                <select id="saleCurrency" class="w-full bg-white font-semibold">
                  <option value="KRW">KRW</option>
                  <option value="USD">USD</option>
                  <option value="RMB">RMB</option>
                </select>
              </div>
              <div class="w-1/2 space-y-1.5">
                <label class="text-[12px] font-bold text-slate-700 ml-1">Ex. Rate</label>
                <input type="number" id="saleRate" class="w-full bg-white font-semibold" value="1" />
              </div>
            </div>
            <div class="space-y-1.5">
              <label class="text-[12px] font-bold text-slate-700 ml-1">Transaction Date</label>
              <input type="date" id="saleDate" class="w-full bg-white font-semibold" />
            </div>

            <div class="md:col-span-1 space-y-1.5 ">
              <label class="text-[12px] font-bold text-slate-700 ml-1">Reference PO</label>
              <div class="flex gap-2">
                <input id="salePoNo" class="w-full bg-white font-semibold" placeholder="Reference PO" readonly />
                <button type="button" id="btnPickPoNo"
                  class="px-3 py-2 bg-slate-200 rounded-xl hover:bg-slate-300 transition-colors">ğŸ“¦</button>
              </div>
            </div>
          </div>

          <div class="border border-slate-200 rounded-2xl overflow-hidden shadow-sm bg-white">
            <div class="flex items-center justify-between p-4 bg-slate-50 border-bottom border-slate-200">
              <h4 class="font-bold text-sm text-slate-700">Line Items</h4>
              <button id="addItem" type="button"
                class="text-xs font-bold bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition shadow-md">+
                Add New Row</button>
            </div>
            <div class="overflow-auto max-h-[400px]">
              <table class="w-full text-sm border-none" id="itemsTable">
                <thead>
                  <tr class="border-b bg-slate-100/50">
                    <th class="w-40">Product Code</th>
                    <th>Product Name</th>
                    <th>Specs</th>
                    <th class="w-24">Qty</th>
                    <th class="w-32">Unit Price</th>
                    <th class="w-32">Total Amount</th>
                    <th class="w-16"></th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100"></tbody>
              </table>
            </div>
            <div class="bg-slate-900 p-6 flex justify-between items-center text-white">
              <div class="text-slate-400 text-sm font-medium">Grand Total Value</div>
              <div id="saleTotal" class="text-3xl font-black tracking-tighter">â‚©0</div>
            </div>
          </div>

          <div class="flex justify-end items-center gap-4 pt-4">
            <button id="btnPrintStatement"
              class="px-6 py-3 bg-slate-100 text-slate-900 font-bold rounded-xl hover:bg-slate-200 transition hidden">ğŸ–¨ï¸
              Transaction Statement</button>
            <button id="btnSaveSale" class="btn-primary px-10">Register Final Transaction</button>
            <span id="saleMsg"
              class="absolute right-6 bottom-6 bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transform translate-y-2 opacity-0 transition-all">Success
              Saved!</span>
          </div>
        </div>
      </div>

      <!-- ë§¤ì¶œ ì¡°íšŒ -->
      <div id="tab-sales-search" class="tab hidden">
        <div class="bg-white p-6 rounded-2xl shadow-card space-y-5">
          <h3 class="font-semibold text-lg">ë§¤ì¶œ ì¡°íšŒ</h3>
          <form id="formSalesSearch" class="grid md:grid-cols-5 gap-4 items-end">
            <div>
              <label class="text-sm">ê±°ë˜ì²˜ëª…</label>
              <div class="mt-1 flex gap-2">
                <input id="sCustomer" class="w-full border rounded-xl px-3 py-2 bg-gray-50" placeholder="ì „ì²´" readonly />
                <button type="button" id="btnPickClientSearch" class="btn bg-gray-200">ì„ íƒ</button>
                <button type="button" id="btnClearClientSearch" class="btn bg-gray-100">ì „ì²´</button>
              </div>
              <p class="text-xs text-gray-500 mt-1">ë¯¸ì„ íƒ ë˜ëŠ” â€˜ì „ì²´â€™ í´ë¦­ ì‹œ ê±°ë˜ì²˜ ì œí•œ ì—†ì´ ì¡°íšŒë©ë‹ˆë‹¤.</p>
            </div>
            <div>
              <label class="text-sm">ìƒí’ˆëª…</label>
              <input id="sItem" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="ë¶€ë¶„ê²€ìƒ‰" />
            </div>
            <div>
              <label class="text-sm">ë§¤ì¶œìœ í˜•</label>
              <select id="sType" class="mt-1 w-full border rounded-xl px-3 py-2">
                <option value="" selected>ì „ì²´</option>
                <option value="ë‚´ì">ë‚´ì</option>
                <option value="ì™¸ì">ì™¸ì</option>
              </select>
            </div>
            <div>
              <label class="text-sm">ì‹œì‘ì¼</label>
              <input type="date" id="sFrom" class="mt-1 w-full border rounded-xl px-3 py-2" />
            </div>
            <div>
              <label class="text-sm">ì¢…ë£Œì¼</label>
              <input type="date" id="sTo" class="mt-1 w-full border rounded-xl px-3 py-2" />
            </div>
            <div class="md:col-span-5 flex gap-2">
              <button class="btn bg-emerald-600 text-white px-5">ê²€ìƒ‰</button>
              <button type="button" id="btnReloadSales" class="btn bg-gray-200">ìƒˆë¡œê³ ì¹¨</button>
              <button type="button" id="btnExportExcel" class="btn bg-blue-600 text-white px-5">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </form>

          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left border-b bg-gray-50">
                  <th class="py-2 px-3">ë§¤ì¶œë²ˆí˜¸</th>
                  <th class="py-2 px-3">ë‚ ì§œ</th>
                  <th class="py-2 px-3">ê±°ë˜ì²˜</th>
                  <th class="py-2 px-3">ìƒí’ˆ</th>
                  <th class="py-2 px-3">ê·œê²©</th>
                  <th class="py-2 px-3">ìœ í˜•</th>
                  <th class="py-2 px-3 text-right">ìˆ˜ëŸ‰</th>
                  <th class="py-2 px-3 text-right">ë‹¨ê°€</th>
                  <th class="py-2 px-3 text-right">í•©ê³„</th>
                  <th class="py-2 px-3">ë‹´ë‹¹ì</th>
                  <th class="py-2 px-3">ì‚­ì œ</th>
                  <th class="py-2 px-3">ìˆ˜ì •</th>
                </tr>
              </thead>
              <tbody id="salesTbody"></tbody>
            </table>
          </div>
          <div id="salesSummary" class="text-right text-sm text-gray-700 font-medium mt-3"></div>
        </div>
      </div>

      <!-- ìƒí’ˆ ì…ë ¥ + ì¡°íšŒ -->
      <div id="tab-products-entry" class="tab hidden">
        <div class="premium-card shadow-premium space-y-8">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold text-xl text-slate-900">Inventory Catalog</h3>
              <p class="text-sm text-slate-500 mt-1">Manage technical specifications and product master records</p>
            </div>
            <button id="btnViewProducts" type="button"
              class="px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition-all flex items-center gap-2">
              ğŸ“‚ <span>Catalog Archive</span>
            </button>
          </div>

          <form id="productForm" class="space-y-6">
            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 grid md:grid-cols-4 gap-6">
              <div class="space-y-1.5">
                <label
                  class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Classification</label>
                <input id="prodCategory" class="w-full bg-white font-bold" placeholder="e.g. LED Driver" />
              </div>
              <div class="md:col-span-2 space-y-1.5">
                <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Product Designation
                  (Name)</label>
                <input id="prodName" class="w-full bg-white font-black text-slate-900"
                  placeholder="Official Model Name" />
              </div>
              <div class="space-y-1.5">
                <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Cost Base</label>
                <input type="number" id="prodCost" class="w-full bg-white font-bold text-emerald-600 text-right"
                  placeholder="0.00" />
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
              <!-- Technical Parameters -->
              <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 space-y-4">
                <h4
                  class="text-[11px] font-black text-slate-900 uppercase tracking-widest flex items-center gap-2 mb-4">
                  <span class="w-1 h-3 bg-blue-500 rounded-full"></span> Tech Specs
                </h4>
                <div class="grid grid-cols-2 gap-4">
                  <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500">Input Amperage</label>
                    <input id="prodInputA" class="w-full bg-white text-xs" placeholder="e.g. 0.5A" />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500">Output Voltage</label>
                    <input id="prodOutputV" class="w-full bg-white text-xs font-bold" placeholder="e.g. 12V DC" />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500">Output Current</label>
                    <input id="prodOutputA" class="w-full bg-white text-xs font-bold" placeholder="e.g. 5.0A" />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500">Material / Alloy</label>
                    <input id="prodMaterial" class="w-full bg-white text-xs" />
                  </div>
                </div>
              </div>

              <!-- Manufacturing -->
              <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 space-y-4">
                <h4
                  class="text-[11px] font-black text-slate-900 uppercase tracking-widest flex items-center gap-2 mb-4">
                  <span class="w-1 h-3 bg-purple-500 rounded-full"></span> Supply Chain
                </h4>
                <div class="grid grid-cols-2 gap-4">
                  <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500">Origin Manufacturer</label>
                    <input id="prodMaker" class="w-full bg-white text-xs" />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500">Primary Vendor</label>
                    <input id="prodClient" class="w-full bg-white text-xs" />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500">Physical Dimensions</label>
                    <input id="prodSize" class="w-full bg-white text-xs" placeholder="W x H x D" />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-[10px] font-bold text-slate-500">Converter Inclusion</label>
                    <input id="prodConverter" class="w-full bg-white text-xs" />
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 space-y-4">
              <label class="text-[11px] font-black text-slate-900 uppercase tracking-widest">Detail Description &
                Remarks</label>
              <textarea id="prodDetail" rows="3" class="w-full bg-white text-sm"
                placeholder="Detailed engineering notes..."></textarea>
            </div>

            <div class="bg-[#0f172a] p-8 rounded-2xl text-white space-y-6">
              <h4 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Technical Documents
                (Certification)</h4>
              <div class="grid md:grid-cols-5 gap-6">
                <div class="space-y-2">
                  <label class="text-[10px] font-bold text-slate-400">Spec Sheet</label>
                  <input type="file" id="fileSpec"
                    class="text-[10px] block w-full text-slate-300 file:bg-slate-700 file:border-none file:text-white file:rounded-lg file:px-2 file:py-1" />
                </div>
                <div class="space-y-2">
                  <label class="text-[10px] font-bold text-slate-400">KS/KC Cert</label>
                  <input type="file" id="fileKSKC"
                    class="text-[10px] block w-full text-slate-300 file:bg-slate-700 file:border-none file:text-white file:rounded-lg file:px-2 file:py-1" />
                </div>
                <div class="space-y-2">
                  <label class="text-[10px] font-bold text-slate-400">EMI Cert</label>
                  <input type="file" id="fileEMI"
                    class="text-[10px] block w-full text-slate-300 file:bg-slate-700 file:border-none file:text-white file:rounded-lg file:px-2 file:py-1" />
                </div>
                <div class="space-y-2">
                  <label class="text-[10px] font-bold text-slate-400">Efficiency</label>
                  <input type="file" id="fileEfficiency"
                    class="text-[10px] block w-full text-slate-300 file:bg-slate-700 file:border-none file:text-white file:rounded-lg file:px-2 file:py-1" />
                </div>
                <div class="space-y-2">
                  <label class="text-[10px] font-bold text-slate-400">Archive (ZIP)</label>
                  <input type="file" id="fileEtc"
                    class="text-[10px] block w-full text-slate-300 file:bg-slate-700 file:border-none file:text-white file:rounded-lg file:px-2 file:py-1"
                    accept=".zip,.rar" />
                </div>
              </div>
            </div>

            <div class="flex justify-end gap-4 pt-4">
              <span id="prodMsg" class="text-emerald-500 font-bold text-sm hidden self-center">âœ“ Data transmission
                successful</span>
              <button id="btnSaveProduct" type="button" class="btn-primary px-16">Commit to Master DB</button>
            </div>
          </form>

          <!-- ìƒí’ˆ ì¡°íšŒ ë¦¬ìŠ¤íŠ¸ -->
          <div id="productListPanel" class="mt-12 hidden space-y-6">
            <div class="flex items-center justify-between">
              <h4
                class="font-black text-slate-900 uppercase tracking-tighter text-lg underline decoration-blue-500 decoration-4 underline-offset-4">
                Inventory Records</h4>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">ğŸ”</span>
                <input id="productListSearch"
                  class="pl-9 pr-4 py-2 border rounded-xl text-sm focus:w-80 transition-all font-semibold"
                  placeholder="Filter by Name, Maker, or Code..." />
              </div>
            </div>

            <div class="overflow-auto border border-slate-200 rounded-2xl shadow-sm max-h-[500px]">
              <table class="w-full text-xs">
                <thead>
                  <tr class="bg-slate-50 border-b sticky top-0 z-10">
                    <th class="p-4 text-left">Internal Code</th>
                    <th class="p-4 text-left">Designation</th>
                    <th class="p-4">Manufacturer</th>
                    <th class="p-4">Primary Source</th>
                    <th class="p-4">Base Cost</th>
                    <th class="p-4">Tech Config</th>
                    <th class="p-4">Material</th>
                  </tr>
                </thead>
                <tbody id="productListBody" class="divide-y divide-slate-100 bg-white"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ê±°ë˜ì²˜ ë“±ë¡ + ì¡°íšŒ -->
      <div id="tab-clients" class="tab hidden">
        <div class="premium-card shadow-premium space-y-8">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-bold text-xl text-slate-900">Partner Management</h3>
              <p class="text-sm text-slate-500 mt-1">Register and maintain your global business partners</p>
            </div>
            <button id="btnViewClients" type="button"
              class="px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition-all flex items-center gap-2">
              ğŸ“‚ <span>Partner Archive</span>
            </button>
          </div>

          <form id="clientForm" class="space-y-10">
            <div class="space-y-6">
              <!-- Group 1: Basic Identity -->
              <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 grid md:grid-cols-4 gap-6">
                <div class="md:col-span-2 space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Company Name
                    *</label>
                  <input id="cName" class="w-full bg-white font-bold text-slate-900" placeholder="Legal Entity Name"
                    required />
                </div>
                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Partner
                    Type</label>
                  <select id="cType" class="w-full bg-white font-semibold">
                    <option value="ê³ ê°">Customer</option>
                    <option value="ê³µê¸‰ì²˜">Supplier</option>
                    <option value="ê²¸ìš©" selected>Dual Role</option>
                  </select>
                </div>
                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Representative
                    (CEO)</label>
                  <input id="cCEO" class="w-full bg-white font-semibold" placeholder="Full Name" />
                </div>
              </div>

              <!-- Group 2: Business Details -->
              <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 grid md:grid-cols-4 gap-6">
                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Business
                    Registration #</label>
                  <input id="cBizNo" class="w-full bg-white font-mono" placeholder="000-00-00000" />
                </div>
                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Industry
                    Type</label>
                  <input id="cIndustry" class="w-full bg-white" placeholder="Trading / Mfg" />
                </div>
                <div class="md:col-span-2 space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Registered
                    Address</label>
                  <input id="cAddress" class="w-full bg-white text-sm" placeholder="Street Address" />
                </div>
                <div class="md:col-span-2 space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Sub Address /
                    Building</label>
                  <input id="cAddress2" class="w-full bg-white text-sm" placeholder="Apt, Suite, Room" />
                </div>
                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Primary
                    Email</label>
                  <input type="email" id="cEmail" class="w-full bg-white" placeholder="billing@partner.com" />
                </div>
                <div class="space-y-1.5 flex gap-4">
                  <div class="w-1/2 space-y-1.5">
                    <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Phone</label>
                    <input id="cTel" class="w-full bg-white text-xs" />
                  </div>
                  <div class="w-1/2 space-y-1.5">
                    <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Fax</label>
                    <input id="cFax" class="w-full bg-white text-xs" />
                  </div>
                </div>
              </div>

              <!-- Group 3: Financials & Files -->
              <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 grid md:grid-cols-4 gap-6">
                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Settlement
                    Currency</label>
                  <select id="cCurrency" class="w-full bg-white font-bold">
                    <option value="KRW" selected>KRW</option>
                    <option value="USD">USD</option>
                    <option value="JPY">JPY</option>
                    <option value="RMB">RMB</option>
                  </select>
                </div>
                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Bank Name</label>
                  <input id="cBank" class="w-full bg-white" placeholder="Standard Chartered" />
                </div>
                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Account
                    Number</label>
                  <input id="cAccountNo" class="w-full bg-white font-mono" />
                </div>
                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Account
                    Holder</label>
                  <input id="cAccountHolder" class="w-full bg-white" />
                </div>

                <div class="space-y-2">
                  <label class="text-[11px] font-black text-slate-400 uppercase">Biz Certificate (PDF/IMG)</label>
                  <input type="file" id="cBizFile"
                    class="text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-200 file:text-slate-700 hover:file:bg-slate-300" />
                </div>
                <div class="space-y-2">
                  <label class="text-[11px] font-black text-slate-400 uppercase">Bank Copy</label>
                  <input type="file" id="cBankFile"
                    class="text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-200 file:text-slate-700 hover:file:bg-slate-300" />
                </div>

                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">VAT Status</label>
                  <select id="cTaxType" class="w-full bg-white font-semibold">
                    <option value="ê³¼ì„¸" selected>Taxable</option>
                    <option value="ë©´ì„¸">Exempt</option>
                  </select>
                </div>
                <div class="space-y-1.5">
                  <label class="text-[12px] font-bold text-slate-400 uppercase tracking-widest ml-1">Reg. Date</label>
                  <input type="date" id="cRegDate" class="w-full bg-white" />
                </div>
              </div>
            </div>

            <div class="flex justify-end pt-4 border-t border-slate-100">
              <div class="flex items-center gap-4">
                <span id="clientMsg" class="text-emerald-600 font-bold text-sm hidden">âœ“ Profile updated
                  successfully</span>
                <button id="btnSaveClient" type="button" class="btn-primary px-16">Save Partner Profile</button>
              </div>
            </div>
          </form>

          <!-- ê±°ë˜ì²˜ ì¡°íšŒ ë¦¬ìŠ¤íŠ¸ -->
          <div id="clientListPanel" class="mt-12 hidden space-y-6">
            <div class="flex items-center justify-between">
              <h4
                class="font-black text-slate-900 uppercase tracking-tighter text-lg underline decoration-emerald-500 decoration-4 underline-offset-4">
                Active Directory</h4>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">ğŸ”</span>
                <input id="clientListSearch"
                  class="pl-9 pr-4 py-2 border rounded-xl text-sm focus:w-80 transition-all font-semibold"
                  placeholder="Search by name, CEO or ID..." />
              </div>
            </div>

            <div class="overflow-auto border border-slate-200 rounded-2xl shadow-sm">
              <table class="w-full text-xs">
                <thead>
                  <tr class="bg-slate-50 border-b">
                    <th class="p-4 text-left">Entity Name</th>
                    <th class="p-4">Type</th>
                    <th class="p-4">Represent.</th>
                    <th class="p-4">Biz ID</th>
                    <th class="p-4 text-left">Contact Point</th>
                    <th class="p-4">Finance</th>
                    <th class="p-4">Status</th>
                    <th class="p-4 w-10"></th>
                  </tr>
                </thead>
                <tbody id="clientListBody" class="divide-y divide-slate-100 bg-white"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ê²¬ì ì„œ ì‘ì„± -->
      <div id="tab-quotes" class="tab hidden">
        <div class="premium-card shadow-premium space-y-8">
          <div class="flex justify-between items-end">
            <div>
              <h3 class="font-bold text-xl text-slate-900">Commercial Quotation</h3>
              <p class="text-sm text-slate-500 mt-1">Generate formal business estimates for verified partners</p>
            </div>
            <div class="text-right">
              <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Quote ID</span>
              <span id="quoteNo"
                class="text-lg font-black text-emerald-600 font-mono tracking-tighter italic">DRAFTING...</span>
            </div>
          </div>

          <div class="grid md:grid-cols-4 gap-6 p-6 bg-slate-50 rounded-2xl border border-slate-100">
            <div class="md:col-span-2 space-y-1.5">
              <label class="text-[12px] font-bold text-slate-700 ml-1 uppercase tracking-wider">Recipient Entity</label>
              <div class="flex gap-2">
                <input id="quoteClient" class="w-full bg-white font-bold" placeholder="Select Target Partner"
                  readonly />
                <button type="button" id="btnPickClientQuote"
                  class="px-3 py-2 bg-slate-200 rounded-xl hover:bg-slate-300 transition-colors">ğŸ¢</button>
              </div>
            </div>
            <div class="space-y-1.5">
              <label class="text-[12px] font-bold text-slate-700 ml-1 uppercase tracking-wider">Validity Date</label>
              <input type="date" id="quoteDate" class="w-full bg-white font-semibold" />
            </div>
            <div class="space-y-1.5">
              <label class="text-[12px] font-bold text-slate-700 ml-1 uppercase tracking-wider">Primary
                Condition</label>
              <input id="quoteTerms" class="w-full bg-white font-semibold" placeholder="FOB, Net 30, etc." />
            </div>
          </div>

          <div class="border border-slate-200 rounded-2xl overflow-hidden shadow-sm bg-white">
            <div class="flex items-center justify-between p-4 bg-slate-50 border-bottom border-slate-200">
              <h4 class="font-bold text-sm text-slate-700 uppercase tracking-tighter">Line-Item Valuation</h4>
              <button id="btnAddQuoteItem" type="button"
                class="text-xs font-bold bg-[#0f172a] text-white px-4 py-2 rounded-lg hover:opacity-90 transition shadow-md">+
                Add Valuation Row</button>
            </div>
            <div class="overflow-auto max-h-[500px]">
              <table class="w-full text-[11px] border-none" id="quoteItems">
                <thead>
                  <tr class="border-b bg-slate-100/50">
                    <th class="w-12">Search</th>
                    <th class="w-48 text-left">Product / Model</th>
                    <th class="text-left">Tech Spec / Description</th>
                    <th class="w-16">Volt</th>
                    <th class="w-16">Watt</th>
                    <th class="w-16">Eff.</th>
                    <th class="w-16">Lumen</th>
                    <th class="w-16">CCT</th>
                    <th class="w-20">Unit</th>
                    <th class="w-24">Price</th>
                    <th class="w-16">Qty</th>
                    <th class="w-28">Amount</th>
                    <th class="w-10"></th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100"></tbody>
              </table>
            </div>
            <div class="bg-emerald-600 p-4 flex justify-between items-center text-white">
              <div class="text-emerald-100 text-xs font-bold uppercase tracking-widest">Aggregate Quote Value</div>
              <div id="quoteSummary" class="text-xl font-black tracking-tight">Total: â‚©0</div>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-2">
              <label class="text-[12px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                <span class="w-1 h-3 bg-slate-300 rounded-full"></span> General Stipulations
              </label>
              <textarea id="quoteGeneral" rows="4" class="w-full bg-slate-50 border-slate-200 text-sm font-medium"
                placeholder="Shipping, Lead-time & Logistics..."></textarea>
            </div>
            <div class="space-y-2">
              <label class="text-[12px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                <span class="w-1 h-3 bg-emerald-500 rounded-full"></span> Exclusive Provisions
              </label>
              <textarea id="quoteSpecial" rows="4" class="w-full bg-slate-50 border-slate-200 text-sm font-medium"
                placeholder="Warranty, Support & Special Waivers..."></textarea>
            </div>
          </div>

          <div class="flex justify-end items-center gap-4 pt-6 border-t border-slate-100">
            <button id="btnPrintQuote"
              class="px-8 py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition shadow-lg hidden flex items-center gap-2">
              <span>ğŸ–¨ï¸ Generate PDF Official</span>
            </button>
            <button id="btnSaveQuote" class="btn-primary px-12">Finalize & Lock Quote</button>
          </div>
        </div>
      </div>

      <!-- ê²¬ì ì„œ ì¡°íšŒ -->
      <div id="tab-quotes-search" class="tab hidden">
        <div class="bg-white p-6 rounded-2xl shadow-card space-y-5">
          <h3 class="font-semibold text-lg">ê²¬ì ì„œ ì¡°íšŒ</h3>
          <form id="formQuoteSearch" class="grid md:grid-cols-5 gap-4 items-end">
            <div>
              <label class="text-sm">ê±°ë˜ì²˜ëª…</label>
              <div class="mt-1 flex gap-2">
                <input id="qsClient" class="w-full border rounded-xl px-3 py-2 bg-gray-50" placeholder="ì „ì²´" readonly />
                <button type="button" id="btnPickClientQuoteSearch" class="btn bg-gray-200">ì„ íƒ</button>
                <button type="button" id="btnClearClientQuoteSearch" class="btn bg-gray-100">ì „ì²´</button>
              </div>
            </div>
            <div>
              <label class="text-sm">ì œí’ˆëª…</label>
              <input id="qsProduct" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="ë¶€ë¶„ê²€ìƒ‰" />
            </div>
            <div>
              <label class="text-sm">ê²¬ì ë²ˆí˜¸</label>
              <input id="qsEstimateNo" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="ì˜ˆ: Q20251113-001" />
            </div>
            <div>
              <label class="text-sm">ì‹œì‘ì¼</label>
              <input type="date" id="qsFrom" class="mt-1 w-full border rounded-xl px-3 py-2" />
            </div>
            <div>
              <label class="text-sm">ì¢…ë£Œì¼</label>
              <input type="date" id="qsTo" class="mt-1 w-full border rounded-xl px-3 py-2" />
            </div>
            <div class="md:col-span-5 flex gap-2">
              <button class="btn bg-emerald-600 text-white px-5">ê²€ìƒ‰</button>
            </div>
          </form>

          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="border-b bg-gray-50">
                  <th class="py-2 px-3">ê²¬ì ë²ˆí˜¸</th>
                  <th class="py-2 px-3">ë‚ ì§œ</th>
                  <th class="py-2 px-3">ê±°ë˜ì²˜</th>
                  <th class="py-2 px-3">ì œí’ˆ</th>
                  <th class="py-2 px-3 text-right">ìˆ˜ëŸ‰</th>
                  <th class="py-2 px-3 text-right">ê¸ˆì•¡</th>
                  <th class="py-2 px-3">í†µí™”</th>
                  <th class="py-2 px-3">ì—´ê¸°</th>
                </tr>
              </thead>
              <tbody id="quoteSearchBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ë°œì£¼ ì…ë ¥ -->
      <div id="tab-po-entry" class="tab hidden">
        <div class="bg-white p-6 rounded-2xl shadow-card space-y-5">
          <h3 class="font-semibold text-lg">ë°œì£¼ ì…ë ¥</h3>
          <div class="text-sm text-gray-600">
            ë°œì£¼ë²ˆí˜¸: <span id="poNo" class="font-semibold text-emerald-700">ìë™ìƒì„±ë¨</span>
          </div>

          <div class="grid md:grid-cols-4 gap-4">
            <div>
              <label class="text-sm">ê³µê¸‰ì²˜(ê±°ë˜ì²˜)</label>
              <div class="mt-1 flex gap-2">
                <input id="poSupplier" class="w-full border rounded-xl px-3 py-2 bg-gray-50" placeholder="ê±°ë˜ì²˜ ì„ íƒ"
                  readonly />
                <button type="button" id="btnPickClientPo" class="btn bg-gray-200">ì„ íƒ</button>
              </div>
            </div>
            <div>
              <label class="text-sm">ë‚ ì§œ</label>
              <input type="date" id="poDate" class="mt-1 w-full border rounded-xl px-3 py-2" />
            </div>
            <div>
              <label class="text-sm">êµ¬ë¶„(Unit)</label>
              <select id="poUnit" class="mt-1 w-full border rounded-xl px-3 py-2">
                <option value="ë‚´ì" selected>ë‚´ì</option>
                <option value="ì™¸ì">ì™¸ì</option>
              </select>
            </div>
            <div>
              <label class="text-sm">í†µí™”</label>
              <select id="poCurrencyEntry" class="mt-1 w-full border rounded-xl px-3 py-2">
                <option value="KRW">KRW</option>
                <option value="USD">USD</option>
                <option value="RMB">RMB</option>
              </select>
            </div>
            <div class="md:col-span-1">
              <label class="text-sm">ì¡°ê±´(Terms)</label>
              <input id="poTerms" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="ë‚©ê¸°, ê²°ì œì¡°ê±´ ë“±" />
            </div>
          </div>

          <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-sm">ë°œì£¼ í•­ëª©</h4>
              <button id="btnAddPoItem" type="button" class="text-sm text-emerald-600 underline">+ í–‰ ì¶”ê°€</button>
            </div>
            <div class="overflow-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="border-b bg-white">
                    <th class="py-2 px-2">ì œí’ˆì„ íƒ</th>
                    <th class="py-2 px-2">ìƒí’ˆì½”ë“œ</th>
                    <th class="py-2 px-2">ì œí’ˆëª…</th>
                    <th class="py-2 px-2">ì„¤ëª…</th>
                    <th class="py-2 px-2">ì „ì••</th>
                    <th class="py-2 px-2">ì „ë ¥</th>
                    <th class="py-2 px-2">íš¨ìœ¨</th>
                    <th class="py-2 px-2">ë£¨ë©˜</th>
                    <th class="py-2 px-2">CCT</th>
                    <th class="py-2 px-2">ë‹¨ê°€</th>
                    <th class="py-2 px-2">ìˆ˜ëŸ‰</th>
                    <th class="py-2 px-2">ê¸ˆì•¡</th>
                    <th class="py-2 px-2">ë¹„ê³ (ìƒí’ˆì½”ë“œ)</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="poItems"></tbody>
              </table>
            </div>
            <div id="poSummary" class="text-right mt-3 text-gray-700 font-medium">
              ì´ ìˆ˜ëŸ‰: 0 / ì´ ê¸ˆì•¡: 0
            </div>
          </div>

          <div class="grid md-grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium">ì¼ë°˜ì‚¬í•­ (General)</label>
              <textarea id="poGeneral" rows="4" class="mt-1 w-full border rounded-xl px-3 py-2 text-sm"
                placeholder="ë‚©ê¸°, í¬ì¥, ìš´ì†¡ ë“±"></textarea>
            </div>
            <div>
              <label class="text-sm font-medium">íŠ¹ê¸°ì‚¬í•­ (Special)</label>
              <textarea id="poSpecial" rows="4" class="mt-1 w-full border rounded-xl px-3 py-2 text-sm"
                placeholder="íŠ¹ë³„ ì¡°ê±´, ìœ ì˜ì‚¬í•­ ë“±"></textarea>
            </div>
            <div>
              <label class="text-sm font-medium">ë¹„ê³  (Notes)</label>
              <textarea id="poNotes" rows="3" class="mt-1 w-full border rounded-xl px-3 py-2 text-sm"
                placeholder="ê¸°íƒ€ ë©”ëª¨"></textarea>
            </div>
          </div>

          <div class="flex justify-end items-center gap-3">
            <button id="btnSavePo" class="btn bg-emerald-600 text-white px-5">ë“±ë¡</button>
            <button id="btnPrintPo" class="btn bg-blue-600 text-white px-5 hidden">ë°œì£¼ì„œ ì¶œë ¥</button>
          </div>
        </div>
      </div>

      <!-- ë°œì£¼ ì¡°íšŒ -->
      <div id="tab-po-search" class="tab hidden">
        <div class="bg-white p-6 rounded-2xl shadow-card space-y-5">
          <h3 class="font-semibold text-lg">ë°œì£¼ ì¡°íšŒ</h3>

          <form id="formPoSearch" class="grid md-grid-cols-5 gap-4 items-end">
            <div>
              <label class="text-sm">ê³µê¸‰ì²˜</label>
              <div class="mt-1 flex gap-2">
                <input id="psSupplier" class="w-full border rounded-xl px-3 py-2 bg-gray-50" placeholder="ì „ì²´"
                  readonly />
                <button type="button" id="btnPickClientPoSearch" class="btn bg-gray-200">ì„ íƒ</button>
                <button type="button" id="btnClearClientPoSearch" class="btn bg-gray-100">ì „ì²´</button>
              </div>
            </div>
            <div>
              <label class="text-sm">ì œí’ˆëª…</label>
              <input id="psProduct" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="ë¶€ë¶„ê²€ìƒ‰" />
            </div>
            <div>
              <label class="text-sm">ë°œì£¼ë²ˆí˜¸</label>
              <input id="psPoNo" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="PO20250101-001" />
            </div>
            <div>
              <label class="text-sm">ì‹œì‘ì¼</label>
              <input type="date" id="psFrom" class="mt-1 w-full border rounded-xl px-3 py-2" />
            </div>
            <div>
              <label class="text-sm">ì¢…ë£Œì¼</label>
              <input type="date" id="psTo" class="mt-1 w-full border rounded-xl px-3 py-2" />
            </div>

            <div class="md:col-span-5 flex gap-2">
              <button class="btn bg-emerald-600 text-white px-5">ê²€ìƒ‰</button>
            </div>
          </form>

          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="border-b bg-gray-50">
                  <th class="py-2 px-3">ë°œì£¼ë²ˆí˜¸</th>
                  <th class="py-2 px-3">ë‚ ì§œ</th>
                  <th class="py-2 px-3">ê³µê¸‰ì²˜</th>
                  <th class="py-2 px-3">ì œí’ˆ</th>
                  <th class="py-2 px-3 text-right">ìˆ˜ëŸ‰</th>
                  <th class="py-2 px-3 text-right">ê¸ˆì•¡</th>
                  <th class="py-2 px-3">í†µí™”</th>
                  <th class="py-2 px-3">ì—´ê¸°</th>
                </tr>
              </thead>
              <tbody id="poSearchBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- ======================================= -->
      <!--           ìˆ˜ì…ì—…ë¬´ íƒ­ ì‹œì‘               -->
      <!-- ======================================= -->

      <div id="tab-import-entry" class="tab hidden">
        <div class="bg-white p-6 rounded-2xl shadow-card space-y-6">
          <h3 class="text-lg font-semibold mb-4">ìˆ˜ì…ì—…ë¬´ ì…ë ¥</h3>

          <!-- ========== ìˆ˜ì…ë²ˆí˜¸ ========== -->
          <div class="text-sm text-gray-600 mb-2">
            ìˆ˜ì…ë²ˆí˜¸: <span id="importNo" class="font-semibold text-emerald-700">ìë™ìƒì„±ë¨</span>
          </div>

          <!-- ============================= -->
          <!--          ê¸°ë³¸ ì •ë³´            -->
          <!-- ============================= -->

          <div class="bg-gray-50 rounded-xl p-4 space-y-4">
            <h4 class="font-semibold text-sm mb-2">ê¸°ë³¸ ì •ë³´</h4>

            <div class="grid md:grid-cols-4 gap-4">

              <div>
                <label class="text-sm">ìˆ˜ì…ì¼ì (Date)</label>
                <input type="date" id="importDate" class="mt-1 w-full border rounded-xl px-3 py-2" />
              </div>

              <div>
                <label class="text-sm">Shipper (Exporter)</label>
                <div class="mt-1 flex gap-2">
                  <input id="importExporter" class="w-full border rounded-xl px-3 py-2 bg-gray-50" placeholder="ê±°ë˜ì²˜ ì„ íƒ"
                    readonly />
                  <button type="button" id="btnPickExporter" class="btn bg-gray-200">ì„ íƒ</button>
                </div>
              </div>

              <div>
                <label class="text-sm">Consignee (Importer)</label>
                <div class="mt-1 flex gap-2">
                  <input id="importImporter" class="w-full border rounded-xl px-3 py-2 bg-gray-50" placeholder="ê±°ë˜ì²˜ ì„ íƒ"
                    readonly />
                  <button type="button" id="btnPickImporter" class="btn bg-gray-200">ì„ íƒ</button>
                </div>
              </div>


              <div>
                <label class="text-sm">Forwarder</label>
                <div class="mt-1 flex gap-2">
                  <input id="importForwarder" class="w-full border rounded-xl px-3 py-2 bg-gray-50" placeholder="ê±°ë˜ì²˜ ì„ íƒ"
                    readonly />
                  <button type="button" id="btnPickForwarder" class="btn bg-gray-200">ì„ íƒ</button>
                </div>
              </div>


              <div>
                <label class="text-sm">ìš´ì†¡ë°©ì‹</label>
                <select id="importTransport" class="mt-1 w-full border rounded-xl px-3 py-2">
                  <option value="SEA">SEA</option>
                  <option value="AIR">AIR</option>
                  <option value="COURIER">COURIER</option>
                </select>
              </div>

              <div>
                <label class="text-sm">ì»¨í…Œì´ë„ˆ ì¢…ë¥˜</label>
                <select id="importContainer" class="mt-1 w-full border rounded-xl px-3 py-2">
                  <option value="20GP">20GP</option>
                  <option value="40GP">40GP</option>
                  <option value="40HQ">40HQ</option>
                  <option value="LCL">LCL</option>
                </select>
              </div>

              <div>
                <label class="text-sm">ì¶œë°œí•­ (POL)</label>
                <input id="importPOL" class="mt-1 w-full border rounded-xl px-3 py-2" />
              </div>

              <div>
                <label class="text-sm">ë„ì°©í•­ (POD)</label>
                <input id="importPOD" class="mt-1 w-full border rounded-xl px-3 py-2" />
              </div>

              <div>
                <label class="text-sm">Vessel / Voyage</label>
                <input id="importVessel" class="mt-1 w-full border rounded-xl px-3 py-2" />
              </div>

              <div>
                <label class="text-sm">Master B/L</label>
                <input id="importBLMaster" class="mt-1 w-full border rounded-xl px-3 py-2" />
              </div>

              <div>
                <label class="text-sm">House B/L</label>
                <input id="importBLHouse" class="mt-1 w-full border rounded-xl px-3 py-2" />
              </div>

              <div>
                <label class="text-sm">í†µí™”</label>
                <select id="importCurrency" class="mt-1 w-full border rounded-xl px-3 py-2">
                  <option value="USD">USD</option>
                  <option value="RMB">RMB</option>
                  <option value="EUR">EUR</option>
                </select>
              </div>

              <div>
                <label class="text-sm">ê´€ì„¸í™˜ìœ¨</label>
                <input type="number" id="importRate" class="mt-1 w-full border rounded-xl px-3 py-2" />
              </div>

            </div>
          </div>

          <!-- ============================= -->
          <!--          ë¹„ìš© ì •ë³´            -->
          <!-- ============================= -->

          <div class="bg-gray-50 rounded-xl p-4 space-y-4">
            <h4 class="font-semibold text-sm mb-2">ë¹„ìš© ì •ë³´ (CBM ê¸°ì¤€ ë°°ë¶„)</h4>

            <div class="grid md:grid-cols-4 gap-4">

              <div>
                <label class="text-sm">ì˜¤ì…˜í”„ë ˆì´íŠ¸ (Freight)</label>
                <input type="number" id="importFreight" class="mt-1 w-full border rounded-xl px-3 py-2 text-right"
                  value="0" />
              </div>

              <div>
                <label class="text-sm">ë¶€ëŒ€ë¹„ìš© (Local Charges)</label>
                <input type="number" id="importLocalCharges" class="mt-1 w-full border rounded-xl px-3 py-2 text-right"
                  value="0" />
              </div>

              <div>
                <label class="text-sm">ê´€ì„¸ìœ¨ (%)</label>
                <input type="number" id="importDutyRate" class="mt-1 w-full border rounded-xl px-3 py-2 text-right"
                  value="0" />
              </div>

              <div>
                <label class="text-sm">ë¶€ê°€ì„¸ìœ¨ (%)</label>
                <input type="number" id="importVatRate" class="mt-1 w-full border rounded-xl px-3 py-2 text-right"
                  value="0" />
              </div>

              <div>
                <label class="text-sm">í†µê´€ì¼ì</label>
                <input type="date" id="importClearanceDate" class="mt-1 w-full border rounded-xl px-3 py-2" />
              </div>

              <div>
                <label class="text-sm">ê´€ì„¸ê¸ˆì•¡</label>
                <input type="number" id="importDutyAmount" class="mt-1 w-full border rounded-xl px-3 py-2 text-right"
                  value="0" />
              </div>

              <div>
                <label class="text-sm">ë¶€ê°€ì„¸ê¸ˆì•¡</label>
                <input type="number" id="importVatAmount" class="mt-1 w-full border rounded-xl px-3 py-2 text-right"
                  value="0" />
              </div>

              <div>
                <label class="text-sm">ì´ë¹„ìš© (Total Cost)</label>
                <input type="number" id="importTotalCost" class="mt-1 w-full border rounded-xl px-3 py-2 text-right"
                  disabled />
              </div>

            </div>
          </div>

          <!-- ============================= -->
          <!--          í’ˆëª© ì…ë ¥            -->
          <!-- ============================= -->

          <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-sm">ìˆ˜ì… í’ˆëª©</h4>
              <button id="btnAddImportItem" type="button" class="text-sm text-emerald-600 underline">+ í–‰ ì¶”ê°€</button>
            </div>

            <div class="overflow-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="border-b bg-white">
                    <th class="py-2 px-2">ì œí’ˆëª…</th>
                    <th class="py-2 px-2">ì œí’ˆì½”ë“œ</th>
                    <th class="py-2 px-2">HS Code</th>
                    <th class="py-2 px-2">ì›ì‚°ì§€</th>
                    <th class="py-2 px-2 text-right">ë‹¨ê°€</th>
                    <th class="py-2 px-2 text-right">ìˆ˜ëŸ‰</th>
                    <th class="py-2 px-2 text-right">ê¸ˆì•¡</th>
                    <th class="py-2 px-2 text-right">CBM</th>
                    <th class="py-2 px-2 text-right">GW</th>
                    <th class="py-2 px-2 text-right">NW</th>
                    <th class="py-2 px-2 text-right">ë°°ë¶€ Freight</th>
                    <th class="py-2 px-2 text-right">ë°°ë¶€ Charges</th>
                    <th class="py-2 px-2 text-right">ìµœì¢… ë‹¨ê°€</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="importItemsBody"></tbody>
              </table>
            </div>

            <div id="importSummary" class="text-right mt-3 text-gray-700 font-medium">
              ì´ ìˆ˜ëŸ‰: 0 / ì´ CBM: 0 / ì´ ê¸ˆì•¡: 0
            </div>
          </div>

          <!-- ============================= -->
          <!--          ì²¨ë¶€íŒŒì¼             -->
          <!-- ============================= -->

          <div class="bg-gray-50 rounded-xl p-4 space-y-4">
            <h4 class="font-semibold text-sm mb-2">íŒŒì¼ ì—…ë¡œë“œ</h4>

            <div class="grid md:grid-cols-4 gap-4 text-sm">
              <div>
                <label class="block mb-1">B/L íŒŒì¼</label>
                <input type="file" id="fileBL" class="w-full text-xs" />
              </div>

              <div>
                <label class="block mb-1">Packing List</label>
                <input type="file" id="filePacking" class="w-full text-xs" />
              </div>

              <div>
                <label class="block mb-1">Invoice</label>
                <input type="file" id="fileInvoice" class="w-full text-xs" />
              </div>

              <div>
                <label class="block mb-1">ê¸°íƒ€ ë¬¸ì„œ</label>
                <input type="file" id="fileOthers" class="w-full text-xs" multiple />
              </div>
            </div>
          </div>

          <!-- ============================= -->
          <!--           ì €ì¥ ë²„íŠ¼           -->
          <!-- ============================= -->

          <div class="flex justify-end items-center gap-3">
            <button id="btnSaveImport" class="btn bg-emerald-600 text-white px-5">ì €ì¥</button>
            <button id="btnPrintImport" class="btn bg-blue-600 text-white px-5 hidden">ìˆ˜ì…ì„œ ì¶œë ¥</button>
            <span id="importMsg" class="text-sm text-green-600 hidden">ë“±ë¡ ì™„ë£Œ!</span>
          </div>

        </div>
      </div>

      <!-- ======================================= -->
      <!--           ìˆ˜ì…ì—…ë¬´ íƒ­ ë                -->
      <!-- ======================================= -->

    </section>

    <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-xs text-gray-500 text-center">
      <p>Â© 2025 YNK Mini ERP Â· Notion ê¸°ë°˜ ERP ì‹œìŠ¤í…œ</p>
    </footer>
  </main>

  <!-- ìƒí’ˆ ì„ íƒ ëª¨ë‹¬ (ë§¤ì¶œìš©) -->
  <div id="productPickerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white p-4 rounded-lg w-full max-w-2xl max-h-[70vh] overflow-auto">
      <h3 class="font-bold mb-2">ì œí’ˆ ì„ íƒ</h3>
      <input type="text" id="productSearch" class="w-full border rounded px-2 py-1 mb-2"
        placeholder="ì½”ë“œ/ì œí’ˆëª…/ì œì¡°ì‚¬ ê²€ìƒ‰..." />
      <table class="min-w-full text-xs">
        <thead>
          <tr class="border-b bg-gray-50">
            <th class="py-1 px-2">ì½”ë“œ</th>
            <th class="py-1 px-2">ì œí’ˆëª…</th>
            <th class="py-1 px-2">ì œì¡°ì‚¬</th>
            <th class="py-1 px-2">íŒë§¤ì‚¬</th>
            <th class="py-1 px-2">ì „ì••</th>
            <th class="py-1 px-2">ì „ë ¥</th>
          </tr>
        </thead>
        <tbody id="productPickerBody"></tbody>
      </table>
      <button class="mt-2 btn bg-gray-200 w-full"
        onclick="document.getElementById('productPickerModal').classList.add('hidden')">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ê²¬ì ìš© ì œí’ˆ ëª¨ë‹¬ -->
  <div id="modalProductsQuote" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white p-4 rounded-lg w-full max-w-xl max-h-[70vh] overflow-auto">
      <h3 class="font-bold mb-2">ì œí’ˆ ì„ íƒ (ê²¬ì )</h3>
      <input type="text" id="modalProductQuoteSearch" class="w-full border rounded px-2 py-1 mb-2"
        placeholder="ê²€ìƒ‰..." />
      <table class="min-w-full text-sm">
        <tbody id="modalProductQuoteList"></tbody>
      </table>
      <button id="btnCloseProductsQuote" class="mt-2 btn bg-gray-200 w-full">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ê±°ë˜ì²˜ ì„ íƒ ëª¨ë‹¬ -->
  <div id="modalClients" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white p-4 rounded-lg w-96 max-h-[70vh] overflow-auto">
      <h3 class="font-bold mb-2">ê±°ë˜ì²˜ ì„ íƒ</h3>
      <input type="text" id="modalClientSearch" class="w-full border rounded px-2 py-1 mb-2" placeholder="ê²€ìƒ‰..." />
      <div id="modalClientList" class="space-y-1"></div>
      <button id="btnCloseClients" class="mt-2 btn bg-gray-200 w-full">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- PoNo ì„ íƒ ëª¨ë‹¬ -->
  <div id="modalPoPicker" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white p-4 rounded-lg w-full max-w-3xl max-h-[80vh] overflow-auto">
      <h3 class="font-bold mb-2">ë°œì£¼ë²ˆí˜¸ ì„ íƒ</h3>
      <input type="text" id="poPickerSearch" class="w-full border rounded px-2 py-1 mb-2"
        placeholder="ê³µê¸‰ì²˜/ì œí’ˆëª…/PoNo ê²€ìƒ‰..." />
      <div class="grid grid-cols-2 gap-4">
        <div>
          <table class="min-w-full text-sm">
            <thead>
              <tr class="border-b bg-gray-50">
                <th class="py-1 px-2">PoNo</th>
                <th class="py-1 px-2">ë‚ ì§œ</th>
                <th class="py-1 px-2">ê³µê¸‰ì²˜</th>
              </tr>
            </thead>
            <tbody id="poPickerList"></tbody>
          </table>
        </div>
        <div>
          <h4 class="font-semibold mb-1">ë°œì£¼ ìƒì„¸</h4>
          <table class="min-w-full text-xs border">
            <thead>
              <tr class="bg-gray-50 border-b">
                <th class="px-2 py-1">ì œí’ˆ</th>
                <th class="px-2 py-1">ìˆ˜ëŸ‰</th>
                <th class="px-2 py-1">ê¸ˆì•¡</th>
              </tr>
            </thead>
            <tbody id="poPickerDetail"></tbody>
          </table>
        </div>
      </div>
      <button id="btnPoPickerClose" class="btn bg-gray-300 w-full mt-4">ë‹«ê¸°</button>
    </div>
  </div>

  <script type="module" defer>
    /* CORE */
    const PROXY = '/api/notion';
    const DB_USERS = '26d1f4ff9a0e800cba14e56be989568b';
    const DB_SALES = '26e1f4ff9a0e801f807fde6aa13b12a0';
    const DB_PRODUCTS = '2a01f4ff9a0e8016aa33c239d64eb482';
    const DB_CLIENTS = '2a11f4ff9a0e80c5b431d7ca0194e149';
    const DB_QUOTES = '2a21f4ff9a0e80a5b6b5fd006e46a44a';
    const DB_PO = '2aa1f4ff9a0e80e792a3d7a68a342917';
    const DB_IMPORT_MASTER = '2af1f4ff9a0e80898f92f5dcd99524f6';
    const DB_IMPORT_ITEMS = '2ae1f4ff9a0e80b18652c3f9448b59fc';

    const rt = t => ({ rich_text: [{ type: 'text', text: { content: String(t || '') } }] });
    const title = t => ({ title: [{ type: 'text', text: { content: String(t || '') } }] });
    const dateISO = i => ({ date: i ? { start: i } : null });
    const select = n => ({ select: n ? { name: String(n) } : null });
    const num = n => ({ number: (n === '' || n == null) ? null : Number(n) });

    async function api(path, body) {
      const r = await fetch(PROXY + path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    const notionQuery = (db, body) => api('/query', { db, ...body });
    const notionCreate = (db, p) => api('/create', { db, properties: p });
    const notionDelete = id => api('/delete', { pageId: id });

    /* SESSION & LOGIN */
    const SESSION_KEY = "ynk_session";
    const SESSION_DURATION = 2 * 60 * 60 * 1000;
    let currentUser = null;

    function getSession() {
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return null;
      try {
        const d = JSON.parse(raw);
        if (Date.now() > d.expires) { localStorage.removeItem(SESSION_KEY); return null; }
        return d;
      } catch {
        localStorage.removeItem(SESSION_KEY);
        return null;
      }
    }
    function saveSession(email) {
      localStorage.setItem(SESSION_KEY, JSON.stringify({ email, expires: Date.now() + SESSION_DURATION }));
    }
    function logout() {
      localStorage.removeItem(SESSION_KEY);
      location.reload();
    }
    async function restoreSession() {
      const s = getSession();
      if (!s) return false;
      currentUser = { Email: s.email };
      return true;
    }
    async function login(email, pass) {
      const f = {
        and: [
          { property: 'Email', email: { equals: email } },
          { property: 'PasswordHash', rich_text: { contains: pass.trim() } }
        ]
      };
      const r = await notionQuery(DB_USERS, { filter: f, page_size: 1 });
      if (!r.results?.length) return false;
      currentUser = { Email: email };
      saveSession(email);
      return true;
    }

    /* GLOBAL */
    let clients = [];       // {name,bizNo,email,tel,ceo}
    let productCodes = [];  // {code,name}
    let productMaster = []; // {code,name,supplier,maker,voltage,watts,eff,lumen,cct}
    let lastSalesRows = []; // ê²€ìƒ‰ ê²°ê³¼ ìºì‹œ (ì—‘ì…€ìš©)
    let currentPickingMode = null;
    let currentQuoteRow = null;
    let currentPoRow = null;  // ë°œì£¼ í–‰ìš©
    let currentPickingClientFor = null;
    let editingClientId = null;

    /* LOADERS */
    async function loadClients() {
      const d = await notionQuery(DB_CLIENTS, {
        sorts: [{ property: 'ClientName', direction: 'ascending' }],
        page_size: 1000
      });

      clients = d.results.map(r => {
        const p = r.properties;
        return {
          name: p.ClientName?.title?.[0]?.plain_text || '',
          bizNo: p.BusinessNo?.rich_text?.[0]?.plain_text || '',
          ceo: p.CEO?.rich_text?.[0]?.plain_text || '',
          email: p.Email?.email || '',
          tel: p.Tel?.rich_text?.[0]?.plain_text || '',
          address: p.Address?.rich_text?.[0]?.plain_text || '',
          fax: p.Fax?.rich_text?.[0]?.plain_text || ''
        };
      });
    }

    async function loadProductCodes() {
      const d = await notionQuery(DB_PRODUCTS, {
        sorts: [{ property: 'ProductCode', direction: 'ascending' }],
        page_size: 1000
      });
      productCodes = d.results.map(r => {
        const p = r.properties;
        return {
          code: p.ProductCode?.rich_text?.[0]?.plain_text || '',
          name: p.ProductName?.rich_text?.[0]?.plain_text || ''
        };
      });
    }
    async function preloadProductMaster() {
      const d = await notionQuery(DB_PRODUCTS, {
        sorts: [{ property: 'ProductCode', direction: 'ascending' }],
        page_size: 1000
      });
      productMaster = d.results.map(r => {
        const p = r.properties;
        return {
          code: p.ProductCode?.rich_text?.[0]?.plain_text || '',
          name: p.ProductName?.rich_text?.[0]?.plain_text || '',
          supplier: p.Supplier?.rich_text?.[0]?.plain_text || '',
          maker: p.Maker?.rich_text?.[0]?.plain_text || '',
          voltage: p.OutputV?.rich_text?.[0]?.plain_text || '',
          watts: p.OutputA?.rich_text?.[0]?.plain_text || '',
          eff: p.Efficiency?.rich_text?.[0]?.plain_text || '',
          lumen: p.Lumen?.rich_text?.[0]?.plain_text || '',
          cct: p.CCT?.rich_text?.[0]?.plain_text || ''
        };
      });
    }

    /* UI INIT */
    function initUI() {
      const authPanel = document.getElementById('authPanel');
      const appPanel = document.getElementById('appPanel');
      const userBadge = document.getElementById('userBadge');
      const userName = document.getElementById('userName');

      document.getElementById('btnLogout').onclick = () => logout();

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
          const targetTab = document.getElementById('tab-' + btn.dataset.tab);
          if (targetTab) targetTab.classList.remove('hidden');
        });
      });

      return {
        showApp(mail) {
          authPanel.style.display = 'none'; // Ensure it doesn't flex center
          appPanel.classList.remove('hidden');
          userBadge.classList.remove('hidden');
          userName.textContent = mail;
          document.body.style.background = 'var(--bg-main)';
        },
        showLogin() {
          appPanel.classList.add('hidden');
          authPanel.classList.remove('hidden');
          authPanel.style.display = 'flex'; // Enable centered flex layout
          userBadge.classList.add('hidden');
          document.body.style.background = 'radial-gradient(circle at top right, #ecfdf5, #f8fafc)';
        }
      };
    }

    /* SALES LOGIC */
    const saleType = document.getElementById('saleType');
    const saleRate = document.getElementById('saleRate');
    const rateHint = document.getElementById('rateHint');
    const itemsBody = document.querySelector('#itemsTable tbody');

    function applySaleTypeRule() {
      const type = saleType.value;
      if (type === 'ë‚´ì') {
        saleRate.value = 1;
        saleRate.setAttribute('disabled', 'disabled');
        rateHint.textContent = 'ë‚´ìëŠ” í™˜ìœ¨ 1ë¡œ ê³ ì •ë©ë‹ˆë‹¤.';
      } else {
        saleRate.removeAttribute('disabled');
        rateHint.textContent = 'ì™¸ìëŠ” í™˜ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš”.';
      }
      calcTotal();
    }
    saleType.addEventListener('change', applySaleTypeRule);
    saleRate.addEventListener('input', calcTotal);

    function addItemRow(code = "", name = "", spec = "", qty = 1, price = 0) {
      const tr = document.createElement('tr');
      tr.className = "hover:bg-slate-50 transition-colors";
      tr.innerHTML = `
    <td class="p-3">
      <div class="flex gap-1 items-center">
        <input class="w-full bg-slate-50 font-mono item-code text-xs" readonly value="${code}">
        <button type="button" class="btnProdSel text-emerald-600 font-bold p-1 hover:bg-emerald-50 rounded">ğŸ”</button>
      </div>
    </td>
    <td class="p-3"><input class="w-full bg-slate-50 item-name text-xs" readonly value="${name}"></td>
    <td class="p-3"><input class="w-full item-spec text-xs" value="${spec}"></td>
    <td class="p-3"><input type="number" class="w-full text-right item-qty font-bold" value="${qty}"></td>
    <td class="p-3"><input type="number" class="w-full text-right item-price font-bold" value="${price}"></td>
    <td class="p-3 item-total text-right font-black text-slate-700">0</td>
    <td class="p-3 text-center"><button type="button" class="text-slate-300 hover:text-red-500 transition-colors btnDel">âœ•</button></td>`;
      tr.querySelector('.btnDel').onclick = () => { tr.remove(); calcTotal(); };
      tr.querySelectorAll('input').forEach(i => i.addEventListener('input', calcTotal));
      tr.querySelector('.btnProdSel').onclick = () => openProductPicker(tr);
      itemsBody.appendChild(tr);
      calcTotal();
    }
    addItemRow();
    document.getElementById('addItem').onclick = () => addItemRow();

    function calcTotal() {
      const rateVal = Number(saleRate.value || 1);
      let total = 0;
      itemsBody.querySelectorAll('tr').forEach(tr => {
        const q = Number(tr.querySelector('.item-qty').value || 0);
        const p = Number(tr.querySelector('.item-price').value || 0);
        const s = q * p * rateVal;
        total += s;
        tr.querySelector('.item-total').textContent = s.toLocaleString('ko-KR');
      });
      document.getElementById('saleTotal').textContent = 'â‚©' + total.toLocaleString('ko-KR');
      return total;
    }

    async function generateSaleCode(date) {
      const prefix = 'S' + date.replace(/-/g, '');
      const r = await notionQuery(DB_SALES, { filter: { property: 'Date', date: { equals: date } } });
      const c = (r.results?.length || 0) + 1;
      return `${prefix}-${String(c).padStart(3, '0')}`;
    }
    // ìƒí’ˆì½”ë“œ ìë™ìƒì„±: PYYYYMMDD-001 í˜•íƒœ
    async function generateProductCode() {
      const today = new Date().toISOString().slice(0, 10);
      const prefix = 'P' + today.replace(/-/g, '');

      const resp = await notionQuery(DB_PRODUCTS, {
        filter: {
          property: 'ProductCode',
          rich_text: { starts_with: prefix }
        },
        page_size: 100
      });

      let maxNo = 0;
      (resp.results || []).forEach(r => {
        const txt = r.properties.ProductCode?.rich_text?.[0]?.plain_text || '';
        const m = txt.match(/-(\d+)$/);
        if (m) {
          const n = Number(m[1]);
          if (!isNaN(n) && n > maxNo) maxNo = n;
        }
      });

      const next = maxNo + 1;
      return `${prefix}-${String(next).padStart(3, '0')}`;
    }

    document.getElementById('btnSaveSale').onclick = async () => {
      try {
        const date = document.getElementById('saleDate').value || new Date().toISOString().slice(0, 10);
        const customer = document.getElementById('saleCustomer').value.trim();
        const rateVal = Number(saleRate.value || 1);
        const type = saleType.value;
        const poNo = document.getElementById('salePoNo').value.trim();

        if (!poNo) { alert('ë°œì£¼ë²ˆí˜¸(PoNo)ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }

        if (!customer) { alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
        if (!clients.find(c => c.name === customer)) { alert('ë“±ë¡ëœ ê±°ë˜ì²˜ê°€ ì•„ë‹™ë‹ˆë‹¤.'); return; }

        const items = [...itemsBody.querySelectorAll('tr')].map(tr => {
          return {
            code: tr.querySelector('.item-code').value.trim(),
            name: tr.querySelector('.item-name').value.trim(),
            spec: tr.querySelector('.item-spec').value.trim(),
            qty: Number(tr.querySelector('.item-qty').value || 0),
            price: Number(tr.querySelector('.item-price').value || 0)
          };
        });

        for (const it of items) {
          if (!it.code) { alert('ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
          const found = productCodes.find(p => p.code === it.code);
          if (!found) { alert(`ë“±ë¡ë˜ì§€ ì•Šì€ ì œí’ˆì½”ë“œ: ${it.code}`); return; }
          it.name = found.name;
        }

        const saleCode = await generateSaleCode(date);
        document.getElementById('saleCodeEl').textContent = saleCode;

        for (const it of items) {
          await notionCreate(DB_SALES, {
            code: rt(saleCode),
            Date: dateISO(date),
            Customer: rt(customer),
            Items: rt(it.name),
            Specification: rt(it.spec),
            SaleType: select(type),
            ExchangeRate: num(rateVal),
            Quantity: num(it.qty),
            UnitPrice: num(it.price),
            Total: num(it.qty * it.price * rateVal),
            Salesperson: rt(currentUser?.Email || ''),
            PoNo: rt(poNo)
          });
        }
        document.getElementById('saleMsg').classList.remove('hidden');
        document.getElementById('btnPrintStatement').classList.remove('hidden');
        setTimeout(() => document.getElementById('saleMsg').classList.add('hidden'), 1500);
      } catch (err) {
        alert('ë“±ë¡ ì˜¤ë¥˜: ' + err.message);
      }
    };
    // ê±°ë˜ëª…ì„¸í‘œ ì¶œë ¥
    document.getElementById('btnPrintStatement').onclick = () => {
      const saleNoEl = document.getElementById('saleCodeEl');
      const saleNo = saleNoEl?.textContent.trim() || '';
      const date = document.getElementById('saleDate').value || new Date().toISOString().slice(0, 10);
      const customer = document.getElementById('saleCustomer').value.trim();

      if (!saleNo || saleNo === 'ìë™ìƒì„±ë¨') {
        alert('ë¨¼ì € ë§¤ì¶œì„ ë“±ë¡í•˜ì„¸ìš”.');
        return;
      }
      if (!customer) {
        alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }

      //  ê±°ë˜ì²˜ ìƒì„¸ ì •ë³´ (clients ë°°ì—´ì—ì„œ ê°€ì ¸ì˜´)
      const cInfo = (clients || []).find(c => c.name === customer) || {};

      const custAddr = `${cInfo.address || ""} ${cInfo.address2 || ""}`.trim();
      const custBizNo = cInfo.bizNo || "";
      const custCEO = cInfo.ceo || "";
      const custTel = cInfo.tel || "";
      const custFax = cInfo.fax || "";
      const custEmail = cInfo.email || "";

      //  ë§¤ì¶œ í•­ëª© ìˆ˜ì§‘
      const rows = [];
      let total = 0;

      document.querySelectorAll('#itemsTable tbody tr').forEach(tr => {
        const code = tr.querySelector('.item-code')?.value || '';
        const name = tr.querySelector('.item-name')?.value || '';
        const spec = tr.querySelector('.item-spec')?.value || '';
        const qty = Number(tr.querySelector('.item-qty')?.value || 0);
        const price = Number(tr.querySelector('.item-price')?.value || 0);
        const amount = qty * price;

        if (!code && !name) return;

        total += amount;

        rows.push({
          Code: code,
          Product: name,
          Spec: spec,
          Qty: qty,
          UnitPrice: price,
          Amount: amount
        });
      });

      if (!rows.length) {
        alert('ë§¤ì¶œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      //  statement.htmlë¡œ ì „ë‹¬í•  ìµœì¢… payload (ê³ ê°ì‚¬ ëª¨ë“  ì •ë³´ í¬í•¨)
      const payload = {
        no: saleNo,
        date: date,

        // ê³µê¸‰ë°›ëŠ”ì(ê±°ë˜ì²˜) ì •ë³´ â€” statement.htmlì—ì„œ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  í•„ë“œ
        customer: customer,
        bizNo: custBizNo,
        ceo: custCEO,
        address: custAddr,
        tel: custTel,
        fax: custFax,
        email: custEmail,

        // í’ˆëª© ë° í•©ê³„
        rows,
        total
      };

      //  ê±°ë˜ëª…ì„¸í‘œ ì¶œë ¥
      const url = `templates/statement.html?data=${encodeURIComponent(JSON.stringify(payload))}`;
      window.open(url, "_blank");
    };

    /* PRODUCT MODAL */
    function openProductPicker(row) {
      window._productPickTargetRow = row;
      renderProductPickerTable('');
      document.getElementById('productPickerModal').classList.remove('hidden');
      document.getElementById('productSearch').focus();
    }
    document.getElementById('productSearch').addEventListener('input', e => {
      renderProductPickerTable(e.target.value.trim());
    });
    function renderProductPickerTable(keyword = '') {
      const tbody = document.getElementById('productPickerBody');
      const kw = (keyword || '').toLowerCase();
      const source = productMaster.length ? productMaster : productCodes.map(p => ({ code: p.code, name: p.name, supplier: '', maker: '', voltage: '', watts: '' }));
      const filtered = source.filter(p => {
        return !kw ||
          p.code.toLowerCase().includes(kw) ||
          p.name.toLowerCase().includes(kw) ||
          (p.maker || '').toLowerCase().includes(kw) ||
          (p.supplier || '').toLowerCase().includes(kw);
      });
      tbody.innerHTML = filtered.map(p => `
    <tr class="hover:bg-gray-100 cursor-pointer" data-code="${p.code}">
      <td class="py-1 px-2">${p.code}</td>
      <td class="py-1 px-2 text-left">${p.name}</td>
      <td class="py-1 px-2">${p.maker || ''}</td>
      <td class="py-1 px-2">${p.supplier || ''}</td>
      <td class="py-1 px-2">${p.voltage || ''}</td>
      <td class="py-1 px-2">${p.watts || ''}</td>
    </tr>`).join('') || `
    <tr><td colspan="6" class="text-center text-gray-400 py-3">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>`;
      tbody.querySelectorAll('tr[data-code]').forEach(tr => {
        tr.onclick = () => {
          const code = tr.dataset.code;
          const target = window._productPickTargetRow;
          const prod = productMaster.find(x => x.code === code) || productCodes.find(x => x.code === code);
          if (!target || !prod) return;
          target.querySelector('.item-code').value = prod.code;
          target.querySelector('.item-name').value = prod.name;
          if (prod.voltage || prod.watts) {
            target.querySelector('.item-spec').value = `${prod.voltage || ''}${(prod.voltage && prod.watts) ? ' / ' : ''}${prod.watts || ''}`;
          }
          document.getElementById('productPickerModal').classList.add('hidden');
          calcTotal();
        };
      });
    }

    /* CLIENT PICKER MODAL */
    document.getElementById('btnPickClient').onclick = () => { currentPickingMode = 'sale-entry'; openClientsModal(); };
    document.getElementById('btnPickClientSearch').onclick = () => { currentPickingMode = 'sales-search'; openClientsModal(); };
    document.getElementById('btnPickClientQuote').onclick = () => { currentPickingMode = 'quotes'; openClientsModal(); };
    document.getElementById('btnPickClientQuoteSearch').onclick = () => { currentPickingMode = 'quotes-search'; openClientsModal(); };
    document.getElementById('btnPickClientPo').onclick = () => { currentPickingMode = 'po-entry'; openClientsModal(); };
    document.getElementById('btnCloseClients').onclick = () => closeClientModal();
    document.getElementById('modalClientSearch').addEventListener('input', e => {
      renderClientList(e.target.value.trim());
    });
    document.getElementById("btnPickExporter").onclick = () => {
      currentPickingMode = "import-exporter";
      openClientsModal();
    };

    document.getElementById("btnPickImporter").onclick = () => {
      currentPickingMode = "import-importer";
      openClientsModal();
    };

    document.getElementById("btnPickForwarder").onclick = () => {
      currentPickingMode = "import-forwarder";
      openClientsModal();
    };

    function openClientsModal() {
      renderClientList('');
      document.getElementById('modalClients').classList.remove('hidden');
      document.getElementById('modalClientSearch').focus();
    }
    function closeClientModal() {
      document.getElementById('modalClients').classList.add('hidden');
    }
    function renderClientList(keyword = '') {
      const kw = (keyword || '').toLowerCase();
      const list = document.getElementById('modalClientList');
      const rows = clients.filter(c => !kw || c.name.toLowerCase().includes(kw)).map(c => `
    <button type="button" class="w-full text-left px-3 py-2 hover:bg-gray-100" data-name="${c.name}">
      ${c.name}
    </button>`).join('') || '<div class="px-3 py-6 text-center text-gray-400">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
      list.innerHTML = rows;
      list.querySelectorAll('button[data-name]').forEach(btn => {
        btn.onclick = () => {
          const name = btn.getAttribute('data-name');
          if (currentPickingMode === 'sale-entry') document.getElementById('saleCustomer').value = name;
          else if (currentPickingMode === 'sales-search') document.getElementById('sCustomer').value = name;
          else if (currentPickingMode === 'quotes') document.getElementById('quoteClient').value = name;
          else if (currentPickingMode === 'quotes-search') document.getElementById('qsClient').value = name;
          else if (currentPickingMode === 'po-entry') document.getElementById('poSupplier').value = name;
          else if (currentPickingMode === 'po-search') document.getElementById('psSupplier').value = name;
          else if (currentPickingMode === 'import-exporter') document.getElementById('importExporter').value = name;
          else if (currentPickingMode === 'import-importer') document.getElementById('importImporter').value = name;
          else if (currentPickingMode === 'import-forwarder') document.getElementById('importForwarder').value = name;
          closeClientModal();
        };
      });
    }

    /* CLIENT SAVE LOGIC */
    document.getElementById('btnSaveClient').onclick = async () => {
      try {
        const data = {
          name: document.getElementById('cName').value.trim(),
          type: document.getElementById('cType').value,
          ceo: document.getElementById('cCEO').value.trim(),
          bizNo: document.getElementById('cBizNo').value.trim(),
          industry: document.getElementById('cIndustry').value.trim(),
          address: document.getElementById('cAddress').value.trim(),   // â˜… ì£¼ì†Œ1
          address2: document.getElementById('cAddress2').value.trim(),  // â˜… ì£¼ì†Œ2
          tel: document.getElementById('cTel').value.trim(),
          fax: document.getElementById('cFax').value.trim(),
          email: document.getElementById('cEmail').value.trim(),
          currency: document.getElementById('cCurrency').value,
          bank: document.getElementById('cBank').value.trim(),
          account: document.getElementById('cAccountNo').value.trim(),
          holder: document.getElementById('cAccountHolder').value.trim(),
          taxType: document.getElementById('cTaxType').value,
          status: document.getElementById('cStatus').value,
          regDate: document.getElementById('cRegDate').value
        };

        if (!data.name) {
          alert('ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }

        // â˜… 1) ìˆ˜ì • ëª¨ë“œë¼ë©´ ê¸°ì¡´ í˜ì´ì§€ ì‚­ì œ
        if (editingClientId) {
          await notionDelete(editingClientId);
        }

        // â˜… 2) ìƒˆ ë°ì´í„°ë¡œ ì¬ë“±ë¡
        await notionCreate(DB_CLIENTS, {
          ClientName: title(data.name),
          Type: select(data.type),       // (DBì—ì„œ ì“°ëŠ” ì´ë¦„ì´ 'Type'ì´ë©´ ê·¸ëŒ€ë¡œ ë‘ì„¸ìš”)
          CEO: rt(data.ceo),
          BusinessNo: rt(data.bizNo),
          Industry: rt(data.industry),
          Address: rt(data.address),
          Address2: rt(data.address2),
          Tel: rt(data.tel),
          Fax: rt(data.fax),
          Email: { email: data.email || null },
          Currency: select(data.currency),
          Bank: rt(data.bank),
          AccountNo: rt(data.account),
          AccountHolder: rt(data.holder),
          TaxType: select(data.taxType),
          Status: select(data.status),
          RegDate: dateISO(data.regDate)
        });

        // â˜… 3) ìƒíƒœ ì´ˆê¸°í™”
        editingClientId = null;
        const btn = document.getElementById('btnSaveClient');
        if (btn) btn.textContent = 'ë“±ë¡';

        // ë©”ì‹œì§€
        document.getElementById('clientMsg').classList.remove('hidden');
        setTimeout(() => document.getElementById('clientMsg').classList.add('hidden'), 1500);

        // â˜… 4) ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¡œë“œ (ê°„ë‹¨ clients + ìƒì„¸ clientList ë‘˜ ë‹¤)
        await loadClients();
        await loadClientsFull();
        renderClientListView();   // ê²€ìƒ‰ìš© ê°„ë‹¨ ë¦¬ìŠ¤íŠ¸
        renderClientListFull();   // ìƒì„¸ ì¡°íšŒ ë¦¬ìŠ¤íŠ¸

      } catch (err) {
        alert('ê±°ë˜ì²˜ ë“±ë¡ ì˜¤ë¥˜: ' + err.message);
      }
    };


    /* CLIENT VIEW */
    const btnViewClients = document.getElementById('btnViewClients');
    const clientListPanel = document.getElementById('clientListPanel');
    const clientListBody = document.getElementById('clientListBody');
    btnViewClients.onclick = async () => {
      await loadClientsFull();       // ëª¨ë“  ê±°ë˜ì²˜ ë¡œë“œ
      renderClientListFull();        // í…Œì´ë¸” ì¶œë ¥
      clientListPanel.classList.remove("hidden");  // í™”ë©´ì— í‘œì‹œ
    };

    document.getElementById('clientListSearch').addEventListener('input', renderClientListView);

    function renderClientListView() {
      const kw = (document.getElementById('clientListSearch').value || '').toLowerCase();
      clientListBody.innerHTML = clients.filter(c => !kw || c.name.toLowerCase().includes(kw)).map(c => `
    <tr class="group hover:bg-slate-50 transition-colors">
      <td class="p-4 text-left">
        <div class="font-bold text-slate-900">${c.name}</div>
        <div class="text-[10px] text-slate-400 font-medium uppercase mt-0.5">${c.address ? c.address.substring(0, 20) + '...' : 'Location Unknown'}</div>
      </td>
      <td class="p-4 text-center">
        <span class="status-badge bg-emerald-50 text-emerald-600">Active</span>
      </td>
      <td class="p-4 text-center font-semibold text-slate-600">${c.ceo || 'â€”'}</td>
      <td class="p-4 text-center font-mono text-slate-500">${c.bizNo || 'â€”'}</td>
      <td class="p-4 text-left">
        <div class="font-semibold text-slate-700 text-xs">${c.email || 'No email'}</div>
        <div class="text-[11px] text-slate-400 mt-0.5">${c.tel || 'No contact'}</div>
      </td>
      <td class="p-4 text-center text-slate-400">â€”</td>
      <td class="p-4 text-center">
        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 mx-auto"></div>
      </td>
      <td class="p-4 text-center">
        <button class="text-slate-300 hover:text-emerald-600 transition-colors">âœ</button>
      </td>
    </tr>`).join('') || `
    <tr><td colspan="8" class="text-center text-slate-400 py-12 px-4 italic font-medium">No partners found matching your search criteria.</td></tr>`;
    }

    /* PRODUCT SAVE */
    document.getElementById('btnSaveProduct').onclick = async () => {
      try {
        const data = {
          category: document.getElementById('prodCategory').value.trim(),
          name: document.getElementById('prodName').value.trim(),
          maker: document.getElementById('prodMaker').value.trim(),
          client: document.getElementById('prodClient').value.trim(),
          cost: Number(document.getElementById('prodCost').value || 0),
          inputA: document.getElementById('prodInputA').value.trim(),
          outV: document.getElementById('prodOutputV').value.trim(),
          outA: document.getElementById('prodOutputA').value.trim(),
          material: document.getElementById('prodMaterial').value.trim(),
          size: document.getElementById('prodSize').value.trim(),
          conv: document.getElementById('prodConverter').value.trim(),
          detail: document.getElementById('prodDetail').value.trim()
        };
        if (!data.name) {
          alert('ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }

        const productCode = await generateProductCode();

        await notionCreate(DB_PRODUCTS, {
          ProductCode: rt(productCode),
          ProductCategory: rt(data.category),
          ProductName: rt(data.name),
          Maker: rt(data.maker),
          Supplier: rt(data.client),
          Cost: num(data.cost),
          InputA: rt(data.inputA),
          OutputV: rt(data.outV),
          OutputA: rt(data.outA),
          Material: rt(data.material),
          Size: rt(data.size),
          Converter: rt(data.conv),
          Detail: rt(data.detail)
        });

        document.getElementById('prodMsg').classList.remove('hidden');
        setTimeout(() => document.getElementById('prodMsg').classList.add('hidden'), 1500);

        await loadProductCodes();
        await preloadProductMaster();
        renderProductListView();

      } catch (err) {
        alert('ìƒí’ˆ ë“±ë¡ ì˜¤ë¥˜: ' + err.message);
      }
    };

    /* PRODUCT VIEW */
    const btnViewProducts = document.getElementById('btnViewProducts');
    const productListPanel = document.getElementById('productListPanel');
    const productListBody = document.getElementById('productListBody');
    document.getElementById("btnViewProducts").onclick = async () => {
      await loadProductsFull();   // â† ì „ì²´ ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°
      renderProductList();        // â† í…Œì´ë¸” ì¶œë ¥
      document.getElementById("productListPanel").classList.remove("hidden");
    };

    document.getElementById('productListSearch').addEventListener('input', renderProductListView);

    function renderProductListView() {
      const kw = (document.getElementById('productListSearch').value || '').toLowerCase();
      const src = productMaster.length ? productMaster : productCodes.map(p => ({ code: p.code, name: p.name, maker: '', supplier: '', voltage: '', watts: '' }));
      productListBody.innerHTML = src.filter(p => {
        return !kw || p.code.toLowerCase().includes(kw) || p.name.toLowerCase().includes(kw);
      }).map(p => `
    <tr class="group hover:bg-slate-50 transition-colors">
      <td class="p-4 text-left font-mono font-bold text-blue-600">${p.code}</td>
      <td class="p-4 text-left">
        <div class="font-bold text-slate-900">${p.name}</div>
        <div class="text-[10px] text-slate-400 font-medium uppercase mt-0.5">${p.material || 'Generic Material'}</div>
      </td>
      <td class="p-4 text-center font-semibold text-slate-600">${p.maker || 'â€”'}</td>
      <td class="p-4 text-center text-slate-500">${p.supplier || 'â€”'}</td>
      <td class="p-4 text-center font-black text-emerald-600">â‚©${(p.cost || 0).toLocaleString()}</td>
      <td class="p-4 text-center">
        <div class="inline-flex items-center gap-1 bg-slate-100 px-2 py-1 rounded text-[10px] font-bold text-slate-600">
            <span>${p.voltage || 'â€”'}</span> / <span>${p.watts || 'â€”'}</span>
        </div>
      </td>
       <td class="p-4 text-center text-slate-400">${p.material || 'â€”'}</td>
    </tr>`).join('') || `
    <tr><td colspan="7" class="text-center text-slate-400 py-12 italic font-medium">No items matched your catalog search.</td></tr>`;
    }

    /* SALES SEARCH */
    const formSalesSearch = document.getElementById('formSalesSearch');
    const salesTbody = document.getElementById('salesTbody');
    const salesSummary = document.getElementById('salesSummary');

    formSalesSearch.addEventListener('submit', async e => {
      e.preventDefault();
      await runSalesSearch();
    });

    document.getElementById('btnReloadSales').onclick = async () => {
      document.getElementById('sCustomer').value = '';
      document.getElementById('sItem').value = '';
      document.getElementById('sType').value = '';
      document.getElementById('sFrom').value = '';
      document.getElementById('sTo').value = '';
      await runSalesSearch();
    };

    document.getElementById('btnClearClientSearch').onclick = () => {
      document.getElementById('sCustomer').value = '';
    };

    document.getElementById('btnExportExcel').onclick = () => {
      if (!lastSalesRows.length) { alert('ì—‘ì…€ë¡œ ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const ws = XLSX.utils.json_to_sheet(lastSalesRows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Sales');
      XLSX.writeFile(wb, 'sales.xlsx');
    };

    async function runSalesSearch() {
      try {
        const customer = document.getElementById('sCustomer').value.trim();
        const item = document.getElementById('sItem').value.trim();
        const type = document.getElementById('sType').value;
        const from = document.getElementById('sFrom').value;
        const to = document.getElementById('sTo').value;

        const and = [];
        if (customer) {
          and.push({ property: 'Customer', rich_text: { contains: customer } });
        }
        if (item) {
          and.push({ property: 'Items', rich_text: { contains: item } });
        }
        if (type) {
          and.push({ property: 'SaleType', select: { equals: type } });
        }
        if (from) {
          and.push({ property: 'Date', date: { on_or_after: from } });
        }
        if (to) {
          and.push({ property: 'Date', date: { on_or_before: to } });
        }

        const filter = and.length ? { and } : undefined;
        const resp = await notionQuery(DB_SALES, {
          filter,
          sorts: [{ property: 'Date', direction: 'descending' }],
          page_size: 200
        });

        lastSalesRows = resp.results.map(r => {
          const p = r.properties;
          return {
            ë§¤ì¶œë²ˆí˜¸: p.code?.rich_text?.[0]?.plain_text || '',
            ë‚ ì§œ: p.Date?.date?.start || '',
            ê±°ë˜ì²˜: p.Customer?.rich_text?.[0]?.plain_text || '',
            ìƒí’ˆ: p.Items?.rich_text?.[0]?.plain_text || '',
            ê·œê²©: p.Specification?.rich_text?.[0]?.plain_text || '',
            ìœ í˜•: p.SaleType?.select?.name || '',
            ìˆ˜ëŸ‰: p.Quantity?.number || 0,
            ë‹¨ê°€: p.UnitPrice?.number || 0,
            í•©ê³„: p.Total?.number || 0,
            ë‹´ë‹¹ì: p.Salesperson?.rich_text?.[0]?.plain_text || '',
            pageId: r.id
          };
        });

        renderSalesTable();
      } catch (err) {
        alert('ë§¤ì¶œ ì¡°íšŒ ì˜¤ë¥˜: ' + err.message);
      }
    }

    function renderSalesTable() {
      let qtySum = 0, totalSum = 0;
      salesTbody.innerHTML = lastSalesRows.map(row => {
        qtySum += row.ìˆ˜ëŸ‰ || 0;
        totalSum += row.í•©ê³„ || 0;
        return `
      <tr class="border-b">
        <td class="py-1 px-3">${row.ë§¤ì¶œë²ˆí˜¸}</td>
        <td class="py-1 px-3">${row.ë‚ ì§œ}</td>
        <td class="py-1 px-3 text-left">${row.ê±°ë˜ì²˜}</td>
        <td class="py-1 px-3 text-left">${row.ìƒí’ˆ}</td>
        <td class="py-1 px-3 text-left">${row.ê·œê²©}</td>
        <td class="py-1 px-3">${row.ìœ í˜•}</td>
        <td class="py-1 px-3 text-right">${(row.ìˆ˜ëŸ‰ || 0).toLocaleString('ko-KR')}</td>
        <td class="py-1 px-3 text-right">${(row.ë‹¨ê°€ || 0).toLocaleString('ko-KR')}</td>
        <td class="py-1 px-3 text-right">${(row.í•©ê³„ || 0).toLocaleString('ko-KR')}</td>
        <td class="py-1 px-3">${row.ë‹´ë‹¹ì || ''}</td>
        <td class="py-1 px-3">
          <button class="text-xs text-red-500 underline" data-id="${row.pageId}">ì‚­ì œ</button>
        </td>
        <td class="py-1 px-3"><button class="text-xs text-blue-600 underline btnEditSale" data-id="${row.pageId}">ìˆ˜ì •</button>
		</td>
    
      </tr>`;
      }).join('') || `
    <tr><td colspan="11" class="text-center text-gray-400 py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      salesSummary.textContent = `ì´ ìˆ˜ëŸ‰: ${qtySum.toLocaleString('ko-KR')} / ì´ í•©ê³„: ${totalSum.toLocaleString('ko-KR')} (í–‰: ${lastSalesRows.length}ê°œ)`;

      salesTbody.querySelectorAll('button[data-id]').forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('í•´ë‹¹ ë§¤ì¶œ í–‰ì„ ì‚­ì œí• ê¹Œìš”?')) return;
          try {
            await notionDelete(btn.dataset.id);
            lastSalesRows = lastSalesRows.filter(r => r.pageId !== btn.dataset.id);
            renderSalesTable();
          } catch (err) {
            alert('ì‚­ì œ ì˜¤ë¥˜: ' + err.message);
          }
        };
      });
    }

    /* QUOTES LOGIC */
    const quoteTable = document.getElementById('quoteItems');
    const quoteSummary = document.getElementById('quoteSummary');

    function addQuoteRow(prefill = {}) {
      const tr = document.createElement('tr');
      tr.className = "hover:bg-slate-50 transition-colors group";
      tr.innerHTML = `
    <td class="p-2 text-center"><button type="button" class="btnPickProduct text-emerald-600 font-bold p-1 hover:bg-emerald-50 rounded transition-colors">ğŸ”</button></td>
    <td class="p-2"><input class="item-name w-full bg-slate-50 font-bold text-slate-800" value="${prefill.name || ''}"></td>
    <td class="p-2"><input class="item-desc w-full bg-transparent text-slate-500" value="${prefill.desc || ''}" placeholder="..."></td>
    <td class="p-2"><input class="item-vol w-full text-center bg-transparent" value="${prefill.voltage || ''}"></td>
    <td class="p-2"><input class="item-watt w-full text-center bg-transparent" value="${prefill.watts || ''}"></td>
    <td class="p-2"><input class="item-eff w-full text-center bg-transparent" value="${prefill.eff || ''}"></td>
    <td class="p-2"><input class="item-lumen w-full text-center bg-transparent" value="${prefill.lumen || ''}"></td>
    <td class="p-2"><input class="item-cct w-full text-center bg-transparent" value="${prefill.cct || ''}"></td>
    <td class="p-2">
      <select class="item-unit w-full bg-transparent font-bold text-slate-500">
        <option value="KRW">KRW</option>
        <option value="USD">USD</option>
        <option value="RMB">RMB</option>
      </select>
    </td>
    <td class="p-2"><input type="number" class="item-price w-full text-right bg-slate-50 font-bold text-slate-900" value="${prefill.price || ''}"></td>
    <td class="p-2"><input type="number" class="item-qty w-full text-right bg-slate-50 font-bold text-emerald-600" value="${prefill.qty || ''}"></td>
    <td class="p-2 item-amount text-right font-black text-slate-900 pr-4">0</td>
    <td class="p-2 text-center"><button type="button" class="btnDel text-slate-300 hover:text-red-500 transition-colors">âœ•</button>
        <span class="item-remark hidden">${prefill.code || ''}</span>
    </td>`;
      quoteTable.appendChild(tr);
      calcQuoteTotal();
    }

    function calcQuoteTotal() {
      let qtySum = 0, amtSum = 0;
      quoteTable.querySelectorAll('tr').forEach(tr => {
        const qty = Number(tr.querySelector('.item-qty')?.value || 0);
        const price = Number(tr.querySelector('.item-price')?.value || 0);
        const amt = qty * price;
        tr.querySelector('.item-amount').textContent = amt.toLocaleString('ko-KR');
        qtySum += qty;
        amtSum += amt;
      });
      quoteSummary.textContent = `ì´ ìˆ˜ëŸ‰: ${qtySum.toLocaleString('ko-KR')} / ì´ ê¸ˆì•¡: ${amtSum.toLocaleString('ko-KR')}`;
    }

    async function generateQuoteNo(date) {
      const prefix = 'Q' + date.replace(/-/g, '');
      const r = await notionQuery(DB_QUOTES, { filter: { property: 'Date', date: { equals: date } } });
      const c = (r.results?.length || 0) + 1;
      return `${prefix}-${String(c).padStart(3, '0')}`;
    }

    // ë°œì£¼ ë²ˆí˜¸ ìƒì„±
    async function generateImportNo(date) {
      const prefix = 'I' + date.replace(/-/g, '');
      const resp = await notionQuery(DB_IMPORT_MASTER, {
        filter: { property: 'Date', date: { equals: date } },
        page_size: 200
      });
      const count = (resp.results?.length || 0) + 1;
      return `${prefix}-${String(count).padStart(3, '0')}`;
    }

    document.getElementById('btnAddQuoteItem').addEventListener('click', () => addQuoteRow({}));

    quoteTable.addEventListener('input', e => {
      if (e.target.matches('.item-qty,.item-price')) calcQuoteTotal();
    });
    quoteTable.addEventListener('click', e => {
      if (e.target.classList.contains('btnDel')) {
        e.target.closest('tr').remove();
        calcQuoteTotal();
      }
      if (e.target.classList.contains('btnPickProduct')) {
        currentQuoteRow = e.target.closest('tr');
        renderProductQuoteList('');
        document.getElementById('modalProductsQuote').classList.remove('hidden');
        document.getElementById('modalProductQuoteSearch').focus();
      }
    });

    document.getElementById('btnCloseProductsQuote').onclick = () => {
      document.getElementById('modalProductsQuote').classList.add('hidden');
    };
    document.getElementById('modalProductQuoteSearch').addEventListener('input', e => {
      renderProductQuoteList(e.target.value.trim());
    });

    function renderProductQuoteList(keyword) {
      const kw = (keyword || '').toLowerCase();
      const tbody = document.getElementById('modalProductQuoteList');

      const rows = (productMaster || []).filter(p => {
        return !kw ||
          p.code.toLowerCase().includes(kw) ||
          p.name.toLowerCase().includes(kw) ||
          p.supplier.toLowerCase().includes(kw) ||
          p.maker.toLowerCase().includes(kw);
      }).map(p => `
    <tr class="border-b hover:bg-gray-50">
      <td class="px-2 py-1">${p.code}</td>
      <td class="px-2 py-1">${p.name}</td>
      <td class="px-2 py-1">${p.supplier}</td>
      <td class="px-2 py-1">${p.maker}</td>
      <td class="px-2 py-1">${p.voltage}</td>
      <td class="px-2 py-1">${p.watts}</td>
      <td class="px-2 py-1">
        <button type="button" class="btnPickThis underline text-emerald-600" data-code="${p.code}">ì„ íƒ</button>
      </td>
    </tr>`).join('') || `
    <tr><td colspan="7" class="text-center text-gray-400 py-4">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>`;

      tbody.innerHTML = rows;

      tbody.querySelectorAll('.btnPickThis').forEach(btn => {
        btn.onclick = () => {
          const code = btn.getAttribute('data-code');
          const p = productMaster.find(x => x.code === code);
          if (!p) return;

          if (currentQuoteRow) {
            currentQuoteRow.querySelector('.item-name').value = p.name;
            currentQuoteRow.querySelector('.item-desc').value = '';
            currentQuoteRow.querySelector('.item-vol').value = p.voltage || '';
            currentQuoteRow.querySelector('.item-watt').value = p.watts || '';
            currentQuoteRow.querySelector('.item-eff').value = p.eff || '';
            currentQuoteRow.querySelector('.item-lumen').value = p.lumen || '';
            currentQuoteRow.querySelector('.item-cct').value = p.cct || '';
            currentQuoteRow.querySelector('.item-remark').textContent = p.code;
            calcQuoteTotal();
          }

          if (currentPoRow) {
            const codeInput = currentPoRow.querySelector('.po-code');
            if (codeInput) codeInput.value = p.code;

            currentPoRow.querySelector('.po-name').value = p.name;
            currentPoRow.querySelector('.po-desc').value = '';
            currentPoRow.querySelector('.po-vol').value = p.voltage || '';
            currentPoRow.querySelector('.po-watt').value = p.watts || '';
            currentPoRow.querySelector('.po-eff').value = p.eff || '';
            currentPoRow.querySelector('.po-lumen').value = p.lumen || '';
            currentPoRow.querySelector('.po-cct').value = p.cct || '';
          }

          document.getElementById('modalProductsQuote').classList.add('hidden');
        };
      });
    }

    document.getElementById('btnSaveQuote').onclick = async () => {
      try {
        const date = document.getElementById('quoteDate').value || new Date().toISOString().slice(0, 10);
        const client = document.getElementById('quoteClient').value.trim();
        if (!client) { alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
        const rows = [...quoteTable.querySelectorAll('tr')];
        if (!rows.length) { alert('ê²¬ì  í•­ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.'); return; }

        const no = await generateQuoteNo(date);
        document.getElementById('quoteNo').textContent = no;

        for (const tr of rows) {
          const unit = tr.querySelector('.item-unit').value;
          const price = Number(tr.querySelector('.item-price').value || 0);
          const qty = Number(tr.querySelector('.item-qty').value || 0);
          await notionCreate(DB_QUOTES, {
            EstimateNo: rt(no),
            Date: dateISO(date),
            Client: rt(client),
            Product: rt(tr.querySelector('.item-name').value),
            Description: rt(tr.querySelector('.item-desc').value),
            Voltage: rt(tr.querySelector('.item-vol').value),
            Watts: rt(tr.querySelector('.item-watt').value),
            LuminousEff: rt(tr.querySelector('.item-eff').value),
            LumenOutput: rt(tr.querySelector('.item-lumen').value),
            CCT: rt(tr.querySelector('.item-cct').value),
            Unit: select(unit),
            UnitPrice: num(price),
            Qty: num(qty),
            Amount: num(qty * price),
            Remarks: rt(tr.querySelector('.item-remark').textContent),
            Terms: rt(document.getElementById('quoteTerms').value),
            GeneralInfo: rt(document.getElementById('quoteGeneral').value),
            SpecialNotes: rt(document.getElementById('quoteSpecial').value)
          });
        }
        alert('ê²¬ì ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê²¬ì ì„œ ì¶œë ¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ PDFë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        document.getElementById('btnPrintQuote').classList.remove('hidden');
      } catch (err) {
        alert('ê²¬ì  ì €ì¥ ì˜¤ë¥˜: ' + err.message);
      }
    };

    document.getElementById('btnPrintQuote').onclick = async () => {
      const estNo = document.getElementById('quoteNo')?.textContent.trim();
      if (!estNo || estNo === 'ìë™ìƒì„±ë¨') {
        alert('ë¨¼ì € ê²¬ì ì„ ë“±ë¡í•˜ì„¸ìš”.');
        return;
      }

      const estDate = document.getElementById('quoteDate').value || new Date().toISOString().slice(0, 10);
      const client = document.getElementById('quoteClient').value.trim();
      const terms = document.getElementById('quoteTerms').value.trim();
      const general = document.getElementById('quoteGeneral').value.trim();
      const special = document.getElementById('quoteSpecial').value.trim();

      if (!client) {
        alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }

      const cInfo = (clients || []).find(c => c.name === client) || {};
      const custAddr = cInfo.address || '';
      const custTel = cInfo.tel || '';
      const custFax = cInfo.fax || '';
      const custEmail = cInfo.email || '';

      const rows = [];
      document.querySelectorAll('#quoteItems tr').forEach(tr => {
        const product = tr.querySelector('.item-name')?.value || '';
        const desc = tr.querySelector('.item-desc')?.value || '';
        if (!product && !desc) return;

        const unitPrice = Number(tr.querySelector('.item-price')?.value || 0);
        const qty = Number(tr.querySelector('.item-qty')?.value || 0);
        let amountText = tr.querySelector('.item-amount')?.textContent || '0';
        amountText = amountText.replace(/,/g, '');
        const amount = Number(amountText || 0);

        rows.push({
          Product: product,
          Description: desc,
          Voltage: tr.querySelector('.item-vol')?.value || '',
          Watts: tr.querySelector('.item-watt')?.value || '',
          Eff: tr.querySelector('.item-eff')?.value || '',
          Lumen: tr.querySelector('.item-lumen')?.value || '',
          CCT: tr.querySelector('.item-cct')?.value || '',
          Unit: tr.querySelector('.item-unit')?.value || '',
          UnitPrice: unitPrice,
          Qty: qty,
          Amount: amount,
          Code: tr.querySelector('.item-remark')?.textContent || ''
        });
      });

      if (!rows.length) {
        alert('ê²¬ì  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const payload = {
        no: estNo,
        date: estDate,
        client,
        address: custAddr,
        tel: custTel,
        fax: custFax,
        email: custEmail,
        terms,
        general,
        special,
        rows
      };

      const url =
        `templates/estimate.html?data=${encodeURIComponent(JSON.stringify(payload))}`;

      window.open(url, '_blank');
    };

    /* ê²¬ì ì„œ ì¡°íšŒ */
    const formQuoteSearch = document.getElementById('formQuoteSearch');
    const quoteSearchBody = document.getElementById('quoteSearchBody');

    document.getElementById('btnClearClientQuoteSearch').onclick = () => {
      document.getElementById('qsClient').value = '';
    };

    formQuoteSearch.addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const client = document.getElementById('qsClient').value.trim();
        const product = document.getElementById('qsProduct').value.trim();
        const estimateNo = document.getElementById('qsEstimateNo').value.trim();
        const from = document.getElementById('qsFrom').value;
        const to = document.getElementById('qsTo').value;

        const and = [];
        if (client) and.push({ property: 'Client', rich_text: { contains: client } });
        if (product) and.push({ property: 'Product', rich_text: { contains: product } });
        if (estimateNo) and.push({ property: 'EstimateNo', rich_text: { contains: estimateNo } });
        if (from) and.push({ property: 'Date', date: { on_or_after: from } });
        if (to) and.push({ property: 'Date', date: { on_or_before: to } });

        const filter = and.length ? { and } : undefined;

        const resp = await notionQuery(DB_QUOTES, {
          filter,
          sorts: [{ property: 'Date', direction: 'descending' }],
          page_size: 200
        });

        const rows = resp.results.map(r => {
          const p = r.properties;
          return {
            estimateNo: p.EstimateNo?.rich_text?.[0]?.plain_text || '',
            date: p.Date?.date?.start || '',
            client: p.Client?.rich_text?.[0]?.plain_text || '',
            product: p.Product?.rich_text?.[0]?.plain_text || '',
            qty: p.Qty?.number || 0,
            amount: p.Amount?.number || 0,
            unit: p.Unit?.select?.name || 'KRW'
          };
        });

        quoteSearchBody.innerHTML = rows.map(row => `
      <tr class="border-b">
        <td class="py-1 px-3">${row.estimateNo}</td>
        <td class="py-1 px-3">${row.date}</td>
        <td class="py-1 px-3 text-left">${row.client}</td>
        <td class="py-1 px-3 text-left">${row.product}</td>
        <td class="py-1 px-3 text-right">${row.qty.toLocaleString('ko-KR')}</td>
        <td class="py-1 px-3 text-right">${row.amount.toLocaleString('ko-KR')}</td>
        <td class="py-1 px-3">${row.unit}</td>
        <td class="py-1 px-3">
          <button type="button" class="text-xs text-blue-600 underline btnOpenEstimate" data-no="${row.estimateNo}">ì—´ê¸°</button>
        </td>
      </tr>`).join('')
          || `<tr><td colspan="8" class="text-center text-gray-400 py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

        document.querySelectorAll('.btnOpenEstimate').forEach(btn => {
          btn.onclick = () => openEstimateFromSearch(btn.dataset.no);
        });

      } catch (err) {
        alert('ê²¬ì  ì¡°íšŒ ì˜¤ë¥˜: ' + err.message);
      }
    });

    // ê²¬ì ì„œ ì—´ê¸°
    async function openEstimateFromSearch(no) {
      if (!no) return alert("ê²¬ì ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.");

      const r = await notionQuery(DB_QUOTES, {
        filter: { property: 'EstimateNo', rich_text: { equals: no } },
        page_size: 200
      });

      if (!r.results.length) {
        alert("ê²¬ì  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const rows = r.results.map(x => {
        const p = x.properties;
        return {
          Product: p.Product?.rich_text?.[0]?.plain_text || '',
          Description: p.Description?.rich_text?.[0]?.plain_text || '',
          Voltage: p.Voltage?.rich_text?.[0]?.plain_text || '',
          Watts: p.Watts?.rich_text?.[0]?.plain_text || '',
          Eff: p.LuminousEff?.rich_text?.[0]?.plain_text || '',
          Lumen: p.LumenOutput?.rich_text?.[0]?.plain_text || '',
          CCT: p.CCT?.rich_text?.[0]?.plain_text || '',
          Unit: p.Unit?.select?.name || 'KRW',
          UnitPrice: p.UnitPrice?.number || 0,
          Qty: p.Qty?.number || 0,
          Amount: p.Amount?.number || 0,
          Code: p.Remarks?.rich_text?.[0]?.plain_text || ''
        };
      });

      const first = r.results[0].properties;
      const clientName = first.Client?.rich_text?.[0]?.plain_text || '';

      const cust = clients.find(x => x.name === clientName) || {};

      const payload = {
        no,
        date: first.Date?.date?.start,
        client: clientName,
        address: cust.address || '',
        tel: cust.tel || '',
        fax: cust.fax || '',
        email: cust.email || '',
        terms: first.Terms?.rich_text?.[0]?.plain_text || '',
        general: first.GeneralInfo?.rich_text?.[0]?.plain_text || '',
        special: first.SpecialNotes?.rich_text?.[0]?.plain_text || '',
        rows
      };

      window.open(
        `templates/estimate.html?data=${encodeURIComponent(JSON.stringify(payload))}`,
        '_blank'
      );
    }

    /* PO SEARCH */
    const formPoSearch = document.getElementById('formPoSearch');
    const poSearchBody = document.getElementById('poSearchBody');

    document.getElementById('btnPickClientPoSearch').onclick = () => {
      currentPickingMode = 'po-search';
      openClientsModal();
    };

    document.getElementById('btnClearClientPoSearch').onclick = () => {
      document.getElementById('psSupplier').value = '';
    };

    formPoSearch.addEventListener('submit', async e => {
      e.preventDefault();

      try {
        const supplier = document.getElementById('psSupplier').value.trim();
        const product = document.getElementById('psProduct').value.trim();
        const poNo = document.getElementById('psPoNo').value.trim();
        const from = document.getElementById('psFrom').value;
        const to = document.getElementById('psTo').value;

        const and = [];
        if (supplier) and.push({ property: 'Supplier', rich_text: { contains: supplier } });
        if (product) and.push({ property: 'Product', rich_text: { contains: product } });
        if (poNo) and.push({ property: 'PoNo', rich_text: { contains: poNo } });
        if (from) and.push({ property: 'Date', date: { on_or_after: from } });
        if (to) and.push({ property: 'Date', date: { on_or_before: to } });

        const filter = and.length ? { and } : undefined;

        const resp = await notionQuery(DB_PO, {
          filter,
          sorts: [{ property: 'Date', direction: 'descending' }],
          page_size: 200
        });

        const rows = resp.results.map(r => {
          const p = r.properties;
          return {
            poNo: p.PoNo?.rich_text?.[0]?.plain_text || '',
            date: p.Date?.date?.start || '',
            supplier: p.Supplier?.rich_text?.[0]?.plain_text || '',
            product: p.Product?.rich_text?.[0]?.plain_text || '',
            qty: p.Qty?.number || 0,
            amount: p.Amount?.number || 0,
            unit: p.Unit?.select?.name || 'KRW'
          };
        });

        poSearchBody.innerHTML = rows.map(row => `
      <tr class="border-b">
        <td class="py-1 px-3">${row.poNo}</td>
        <td class="py-1 px-3">${row.date}</td>
        <td class="py-1 px-3 text-left">${row.supplier}</td>
        <td class="py-1 px-3 text-left">${row.product}</td>
        <td class="py-1 px-3 text-right">${row.qty.toLocaleString('ko-KR')}</td>
        <td class="py-1 px-3 text-right">${row.amount.toLocaleString('ko-KR')}</td>
        <td class="py-1 px-3">${row.unit}</td>
        <td class="py-1 px-3">
          <button class="text-xs text-blue-600 underline btnOpenPo"
                  data-no="${row.poNo}">
            ì—´ê¸°
          </button>
        </td>
      </tr>
    `).join('') || `
      <tr>
        <td colspan="8" class="text-center text-gray-400 py-4">
          ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
        </td>
      </tr>
    `;

        document.querySelectorAll('.btnOpenPo').forEach(btn => {
          btn.onclick = () => openPoFromSearch(btn.dataset.no);
        });

      } catch (err) {
        alert('ë°œì£¼ ì¡°íšŒ ì˜¤ë¥˜: ' + err.message);
      }
    });

    /* ===========================================================
       0) ëŒ€ì‹œë³´ë“œ ìš”ì†Œ ì„ íƒ
    =========================================================== */
    const dashPo = document.getElementById('dashPo');
    const dashPoDetail = document.getElementById('dashPoDetail');
    const dashPoYtd = document.getElementById('dashPoYtd');
    const dashPoYtdDetail = document.getElementById('dashPoYtdDetail');

    const dashSales = document.getElementById('dashSales');
    const dashSalesDetail = document.getElementById('dashSalesDetail');
    const dashSalesYtd = document.getElementById('dashSalesYtd');
    const dashSalesYtdDetail = document.getElementById('dashSalesYtdDetail');

    const dashClients = document.getElementById('dashClients');


    /* ===========================================================
        ë‚ ì§œ ìœ í‹¸
    =========================================================== */
    function getMonthRange(d = new Date()) {
      const y = d.getFullYear();
      const m = d.getMonth();
      const start = new Date(y, m, 1).toISOString().slice(0, 10);
      const end = new Date(y, m + 1, 0).toISOString().slice(0, 10);
      return { start, end };
    }

    function getYearRange(d = new Date()) {
      const y = d.getFullYear();
      const start = `${y}-01-01`;
      const end = `${y}-12-31`;
      return { start, end };
    }


    /* ===========================================================
       1) ì´ë²ˆë‹¬ ë°œì£¼ (í™˜ìœ¨ ì ìš©)
    =========================================================== */
    async function loadDashboardPo() {
      const { start, end } = getMonthRange();

      const FX_USD = 1500;
      const FX_RMB = 210;

      const r = await notionQuery(DB_PO, {
        filter: {
          and: [
            { property: "Date", date: { on_or_after: start } },
            { property: "Date", date: { on_or_before: end } }
          ]
        },
        page_size: 1000
      });

      const sum = { KRW: 0, USD: 0, RMB: 0 };

      (r.results || []).forEach(item => {
        const p = item.properties;
        const cur = p.Unit?.select?.name || "KRW";
        const amt = p.Amount?.number || 0;
        if (sum[cur] != null) sum[cur] += amt;
      });

      const totalKRW =
        sum.KRW +
        sum.USD * FX_USD +
        sum.RMB * FX_RMB;

      dashPo.textContent = totalKRW.toLocaleString("ko-KR");

      dashPoDetail.innerHTML = `
    <div>â€¢ KRW: <b>${sum.KRW.toLocaleString()}</b></div>
    <div>â€¢ USD: <b>${sum.USD.toLocaleString()}</b></div>
    <div>â€¢ RMB: <b>${sum.RMB.toLocaleString()}</b></div>
    <div class="text-[10px] text-gray-400 mt-1">(í™˜ìœ¨: USD 1500ì› / RMB 210ì›)</div>
  `;
    }


    /* ===========================================================
       2) ì˜¬í•´ ëˆ„ì  ë°œì£¼ (í™˜ìœ¨ ì ìš©)
    =========================================================== */
    async function loadDashboardPoYtd() {
      const { start, end } = getYearRange();

      const FX_USD = 1500;
      const FX_RMB = 210;

      const r = await notionQuery(DB_PO, {
        filter: {
          and: [
            { property: "Date", date: { on_or_after: start } },
            { property: "Date", date: { on_or_before: end } }
          ]
        },
        page_size: 1000
      });

      const sum = { KRW: 0, USD: 0, RMB: 0 };

      (r.results || []).forEach(item => {
        const p = item.properties;
        const cur = p.Unit?.select?.name || "KRW";
        const amt = p.Amount?.number || 0;
        if (sum[cur] != null) sum[cur] += amt;
      });

      const totalKRW =
        sum.KRW +
        sum.USD * FX_USD +
        sum.RMB * FX_RMB;

      dashPoYtd.textContent = totalKRW.toLocaleString("ko-KR");

      dashPoYtdDetail.innerHTML = `
    <div>â€¢ KRW: <b>${sum.KRW.toLocaleString()}</b></div>
    <div>â€¢ USD: <b>${sum.USD.toLocaleString()}</b></div>
    <div>â€¢ RMB: <b>${sum.RMB.toLocaleString()}</b></div>
    <div class="text-[10px] text-gray-400 mt-1">(í™˜ìœ¨: USD 1500ì› / RMB 210ì›)</div>
  `;
    }


    /* ===========================================================
       3) ì´ë²ˆë‹¬ ë§¤ì¶œ (KRW ì´ì•¡)
    =========================================================== */
    async function loadDashboardSales() {
      const { start, end } = getMonthRange();

      const r = await notionQuery(DB_SALES, {
        filter: {
          and: [
            { property: "Date", date: { on_or_after: start } },
            { property: "Date", date: { on_or_before: end } }
          ]
        },
        page_size: 1000
      });

      const total = (r.results || [])
        .reduce((sum, p) => sum + (p.properties.Total?.number || 0), 0);

      dashSales.textContent = total.toLocaleString("ko-KR");
      dashSalesDetail.innerHTML = "";
    }


    /* ===========================================================
       4) ì˜¬í•´ ëˆ„ì  ë§¤ì¶œ (KRW ì´ì•¡)
    =========================================================== */
    async function loadDashboardSalesYtd() {
      const { start, end } = getYearRange();

      const r = await notionQuery(DB_SALES, {
        filter: {
          and: [
            { property: "Date", date: { on_or_after: start } },
            { property: "Date", date: { on_or_before: end } }
          ]
        },
        page_size: 1000
      });

      const total = (r.results || [])
        .reduce((sum, p) => sum + (p.properties.Total?.number || 0), 0);

      dashSalesYtd.textContent = total.toLocaleString("ko-KR");
      dashSalesYtdDetail.innerHTML = "";
    }


    /* ===========================================================
       5) ì „ì²´ ê±°ë˜ì²˜ ìˆ˜
    =========================================================== */
    async function loadDashboardClients() {
      const r = await notionQuery(DB_CLIENTS, { page_size: 1000 });
      const cnt = r.results?.length || 0;
      dashClients.textContent = cnt.toLocaleString("ko-KR");
    }

    /* ===========================================================
       6) ëŒ€ì‹œë³´ë“œ ì „ì²´ ì‹¤í–‰
    =========================================================== */
    async function loadDashboard() {
      await Promise.all([
        loadDashboardPo(),
        loadDashboardPoYtd(),
        loadDashboardSales(),
        loadDashboardSalesYtd(),
        loadDashboardClients()
      ]);
    }




    /* LOGIN & INIT */
    const ui = initUI();

    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const mail = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPassword').value.trim();
      const loginMsg = document.getElementById('loginMsg');
      try {
        const ok = await login(mail, pass);
        if (ok) {
          ui.showApp(mail);
          await loadClients();
          await loadProductCodes();
          await preloadProductMaster();
          applySaleTypeRule();
          addQuoteRow({});
          await runSalesSearch();
          await loadDashboard();  // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
        } else {
          loginMsg.classList.remove('hidden');
          setTimeout(() => loginMsg.classList.add('hidden'), 1500);
        }
      } catch (err) {
        alert('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + err.message);
      }
    });

    /* ë°œì£¼ í•­ëª© ë¡œì§ */
    const poItemsBody = document.getElementById('poItems');
    const poSummary = document.getElementById('poSummary');

    function addPoRow(prefill = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
    <td>
      <button type="button" class="btnPoPickProduct text-emerald-600 underline text-xs">ì„ íƒ</button>
    </td>
    <td><input class="po-code border rounded-xl px-2 py-1 w-28 text-xs" value="${prefill.code || ''}"></td>
    <td><input class="po-name border rounded-xl px-2 py-1 w-full" value="${prefill.name || ''}"></td>
    <td><input class="po-desc border rounded-xl px-2 py-1 w-full" value="${prefill.desc || ''}"></td>
    <td><input class="po-vol border rounded-xl px-2 py-1 w-20 text-center" value="${prefill.voltage || ''}"></td>
    <td><input class="po-watt border rounded-xl px-2 py-1 w-20 text-center" value="${prefill.watts || ''}"></td>
    <td><input class="po-eff border rounded-xl px-2 py-1 w-20 text-center" value="${prefill.eff || ''}"></td>
    <td><input class="po-lumen border rounded-xl px-2 py-1 w-20 text-center" value="${prefill.lumen || ''}"></td>
    <td><input class="po-cct border rounded-xl px-2 py-1 w-20 text-center" value="${prefill.cct || ''}"></td>
    <td><input type="number" class="po-price border rounded-xl px-2 py-1 w-24 text-right" value="${prefill.price || 0}"></td>
    <td><input type="number" class="po-qty border rounded-xl px-2 py-1 w-20 text-right" value="${prefill.qty || 0}"></td>
    <td class="po-amount text-right px-2">0</td>
    <td class="po-remark text-gray-600 text-sm">${prefill.code || ''}</td>
    <td><button type="button" class="btnPoDel text-red-500 text-sm">âœ•</button></td>
  `;

      poItemsBody.appendChild(tr);

      tr.querySelector('.btnPoDel').onclick = () => {
        tr.remove();
        calcPoSummary();
      };

      tr.querySelector('.btnPoPickProduct').onclick = () => {
        currentPoRow = tr;
        renderProductQuoteList('');
        document.getElementById('modalProductsQuote').classList.remove('hidden');
      };

      tr.querySelectorAll('.po-price, .po-qty').forEach(i => {
        i.addEventListener('input', calcPoSummary);
      });

      calcPoSummary();
    }

    function calcPoSummary() {
      let qtySum = 0, amtSum = 0;
      poItemsBody.querySelectorAll('tr').forEach(tr => {
        const qty = Number(tr.querySelector('.po-qty')?.value || 0);
        const price = Number(tr.querySelector('.po-price')?.value || 0);
        const amt = qty * price;
        const amtCell = tr.querySelector('.po-amount');
        if (amtCell) amtCell.textContent = amt.toLocaleString('ko-KR');
        qtySum += qty;
        amtSum += amt;
      });
      if (poSummary) {
        poSummary.textContent =
          `ì´ ìˆ˜ëŸ‰: ${qtySum.toLocaleString('ko-KR')} / ì´ ê¸ˆì•¡: ${amtSum.toLocaleString('ko-KR')}`;
      }
    }

    const btnAddPoItem = document.getElementById('btnAddPoItem');
    if (btnAddPoItem) {
      btnAddPoItem.onclick = () => addPoRow({});
    }

    document.getElementById('btnSavePo').onclick = async () => {
      try {
        const date = document.getElementById('poDate').value || new Date().toISOString().slice(0, 10);
        const supplier = document.getElementById('poSupplier').value.trim();
        const indexType = document.getElementById('poUnit').value.trim();

        const currencyEl = document.getElementById('poCurrencyEntry');
        const currency = currencyEl ? currencyEl.value : 'KRW';

        if (!supplier) {
          alert('ê³µê¸‰ì²˜(ê±°ë˜ì²˜)ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }

        const rowsEls = [...document.querySelectorAll('#poItems tr')];
        if (!rowsEls.length) {
          alert('ë°œì£¼ í•­ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.');
          return;
        }

        const termsEl = document.getElementById('poTerms');
        const generalEl = document.getElementById('poGeneral');
        const specialEl = document.getElementById('poSpecial');

        const terms = termsEl ? termsEl.value.trim() : '';
        const general = generalEl ? generalEl.value.trim() : '';
        const special = specialEl ? specialEl.value.trim() : '';

        const poNo = await generatePoNo(date);
        const poNoSpan = document.getElementById('poNo');
        if (poNoSpan) poNoSpan.textContent = poNo;

        for (const tr of rowsEls) {
          const product = tr.querySelector('.po-name')?.value.trim() || '';
          const desc = tr.querySelector('.po-desc')?.value.trim() || '';
          const voltage = tr.querySelector('.po-vol')?.value.trim() || '';
          const watts = tr.querySelector('.po-watt')?.value.trim() || '';
          const eff = tr.querySelector('.po-eff')?.value.trim() || '';
          const lumen = tr.querySelector('.po-lumen')?.value.trim() || '';
          const cct = tr.querySelector('.po-cct')?.value.trim() || '';
          const price = Number(tr.querySelector('.po-price')?.value || 0);
          const qty = Number(tr.querySelector('.po-qty')?.value || 0);
          const code = tr.querySelector('.po-code')?.value.trim() || '';

          if (!product && !desc && !code) continue;

          await notionCreate(DB_PO, {
            PoNo: rt(poNo),
            Date: dateISO(date),
            Supplier: rt(supplier),

            Product: rt(product),
            Description: rt(desc),
            Voltage: rt(voltage),
            Watts: rt(watts),
            LuminousEff: rt(eff),
            LumenOutput: rt(lumen),
            CCT: rt(cct),

            Index: rt(indexType),
            Unit: select(currency),

            UnitPrice: num(price),
            Qty: num(qty),
            Amount: num(price * qty),

            Remarks: rt(code),
            Terms: rt(terms),
            GeneralInfo: rt(general),
            SpecialNotes: rt(special)
          });
        }

        alert('ë°œì£¼ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë°œì£¼ì„œ ì¶œë ¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ PDFë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        const btnPrintPo = document.getElementById('btnPrintPo');
        if (btnPrintPo) btnPrintPo.classList.remove('hidden');

      } catch (err) {
        alert('ë°œì£¼ ì €ì¥ ì˜¤ë¥˜: ' + err.message);
      }
    };

    // ==============================
    //  ë°œì£¼ì„œ ì¶œë ¥ Payload ì™„ì „ì²´ ìˆ˜ì •ë³¸
    // ==============================
    // ==============================
    //  ë°œì£¼ì„œ ì¶œë ¥ Payload ì™„ì „ì²´
    // ==============================
    document.getElementById('btnPrintPo').onclick = () => {

      const poNo = document.getElementById('poNo').textContent.trim();
      const date = document.getElementById('poDate').value;
      const supplier = document.getElementById('poSupplier').value.trim();

      if (!poNo || poNo === 'ìë™ìƒì„±ë¨') {
        alert("ë¨¼ì € ë°œì£¼ë¥¼ ì €ì¥í•˜ì„¸ìš”.");
        return;
      }

      if (!supplier) {
        alert("ê³µê¸‰ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const cInfo = (clients || []).find(c => c.name === supplier) || {};

      const indexType = document.getElementById('poUnit').value;           // ë‚´ì/ì™¸ì
      const currencyType = document.getElementById('poCurrencyEntry').value;  // KRW/USD/RMB

      const terms = document.getElementById('poTerms').value.trim();
      const general = document.getElementById('poGeneral').value.trim();
      const special = document.getElementById('poSpecial').value.trim();
      const notes = document.getElementById('poNotes').value.trim();

      const rows = [];
      let total = 0;

      document.querySelectorAll('#poItems tr').forEach(tr => {
        const product = tr.querySelector('.po-name')?.value || "";
        const desc = tr.querySelector('.po-desc')?.value || "";
        const code = tr.querySelector('.po-code')?.value || "";
        if (!product && !desc && !code) return;

        const r = {
          Product: product,
          Description: desc,
          Voltage: tr.querySelector('.po-vol')?.value || "",
          Watts: tr.querySelector('.po-watt')?.value || "",
          Eff: tr.querySelector('.po-eff')?.value || "",
          Lumen: tr.querySelector('.po-lumen')?.value || "",
          CCT: tr.querySelector('.po-cct')?.value || "",
          Unit: currencyType,
          UnitPrice: Number(tr.querySelector('.po-price')?.value || 0),
          Qty: Number(tr.querySelector('.po-qty')?.value || 0),
          Remark: code          // â˜… purchase.htmlì—ì„œ Remark í•„ë“œë¥¼ ì‚¬ìš©
        };

        r.Amount = r.UnitPrice * r.Qty;
        total += r.Amount;

        rows.push(r);
      });

      if (!rows.length) {
        alert("ë°œì£¼ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const payload = {
        no: poNo,
        date: date,
        supplier: supplier,

        address: cInfo.address || "",
        tel: cInfo.tel || "",
        fax: cInfo.fax || "",
        email: cInfo.email || "",

        index: indexType,
        currency: currencyType,

        terms: terms,
        general: general,
        special: special,
        notes: notes,

        rows: rows,
        total: total
      };

      // ì‹¤ì œ ì„œë²„ ê²½ë¡œì— ë§ê²Œ ì¡°ì •í•˜ì„¸ìš”.
      const url = `templates/purchase.html?data=${encodeURIComponent(JSON.stringify(payload))}`;
      // ë˜ëŠ” ê°™ì€ ì„œë²„/í´ë”ë¼ë©´: const url = `templates/purchase.html?data=...`
      window.open(url, "_blank");
    };



    /* ë°œì£¼ ìƒì„¸ ì—´ê¸° í•¨ìˆ˜ */
    async function openPoFromSearch(no) {
      if (!no) {
        alert("ë°œì£¼ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      try {
        const resp = await notionQuery(DB_PO, {
          filter: { property: 'PoNo', rich_text: { equals: no } },
          page_size: 200
        });
        if (!resp.results || !resp.results.length) {
          alert('ë°œì£¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // Notion ë°ì´í„° â†’ rows
        const rows = resp.results.map(r => {
          const p = r.properties;
          return {
            Product: p.Product?.rich_text?.[0]?.plain_text || '',
            Description: p.Description?.rich_text?.[0]?.plain_text || '',
            Voltage: p.Voltage?.rich_text?.[0]?.plain_text || '',
            Watts: p.Watts?.rich_text?.[0]?.plain_text || '',
            Eff: p.LuminousEff?.rich_text?.[0]?.plain_text || '',
            Lumen: p.LumenOutput?.rich_text?.[0]?.plain_text || '',
            CCT: p.CCT?.rich_text?.[0]?.plain_text || '',
            Unit: p.Unit?.select?.name || 'KRW',
            UnitPrice: p.UnitPrice?.number || 0,
            Qty: p.Qty?.number || 0,
            Amount: p.Amount?.number || 0,
            Remark: p.Remarks?.rich_text?.[0]?.plain_text || ''   // â˜… ì—¬ê¸°ì„œë¶€í„° Remarkë¡œ í†µì¼
          };
        });

        const first = resp.results[0].properties;
        const supplierName = first.Supplier?.rich_text?.[0]?.plain_text || '';
        const date = first.Date?.date?.start || '';
        const cInfo = (clients || []).find(c => c.name === supplierName) || {};
        const total = rows.reduce((sum, row) => sum + (row.Amount || 0), 0);

        const payload = {
          no: no,
          date: date,
          supplier: supplierName,
          address: cInfo.address || '',
          tel: cInfo.tel || '',
          fax: cInfo.fax || '',
          email: cInfo.email || '',
          index: first.Index?.rich_text?.[0]?.plain_text || '',  // ìˆìœ¼ë©´ ì‚¬ìš©
          currency: first.Unit?.select?.name || 'KRW',
          terms: first.Terms?.rich_text?.[0]?.plain_text || '',
          general: first.GeneralInfo?.rich_text?.[0]?.plain_text || '',
          special: first.SpecialNotes?.rich_text?.[0]?.plain_text || '',
          notes: '',   // í•„ìš”í•˜ë©´ General/Specialê³¼ ë¶„ë¦¬í•´ì„œ ì“°ë„ë¡ ë³€ê²½ ê°€ëŠ¥
          rows,
          total
        };

        const url = `/erp/templates/purchase.html?data=${encodeURIComponent(JSON.stringify(payload))}`;
        window.open(url, '_blank');
      } catch (err) {
        alert('ë°œì£¼ ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ' + err.message);
      }
    }

    /* PoNo Picker Logic */
    let poMaster = [];

    document.getElementById('btnPickPoNo').onclick = async () => {
      await loadPoMaster();
      document.getElementById('modalPoPicker').classList.remove('hidden');
    };

    document.getElementById('btnPoPickerClose').onclick = () => {
      document.getElementById('modalPoPicker').classList.add('hidden');
    };

    document.getElementById('poPickerSearch').addEventListener('input', e => {
      renderPoPickerList(e.target.value.trim());
    });

    async function loadPoMaster() {
      const resp = await notionQuery(DB_PO, {
        sorts: [{ property: 'Date', direction: 'descending' }],
        page_size: 200
      });
      poMaster = resp.results.map(r => {
        const p = r.properties;
        return {
          poNo: p.PoNo?.rich_text?.[0]?.plain_text || '',
          date: p.Date?.date?.start || '',
          supplier: p.Supplier?.rich_text?.[0]?.plain_text || '',
          product: p.Product?.rich_text?.[0]?.plain_text || '',
          qty: p.Qty?.number || 0,
          amount: p.Amount?.number || 0
        };
      });
      renderPoPickerList('');
    }

    function renderPoPickerList(keyword = '') {
      const list = document.getElementById('poPickerList');
      const kw = (keyword || '').toLowerCase();
      const rows = poMaster.filter(po =>
        !kw ||
        po.poNo.toLowerCase().includes(kw) ||
        po.supplier.toLowerCase().includes(kw) ||
        po.product.toLowerCase().includes(kw)
      );
      list.innerHTML = rows.map(po => `
    <tr class="border-b hover:bg-gray-100 cursor-pointer" data-pono="${po.poNo}">
      <td class="px-2 py-1">${po.poNo}</td>
      <td class="px-2 py-1">${po.date}</td>
      <td class="px-2 py-1">${po.supplier}</td>
    </tr>
  `).join('') || `<tr><td colspan="3" class="text-center text-gray-400 py-3">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>`;
      list.querySelectorAll('tr[data-pono]').forEach(tr => {
        tr.onclick = () => {
          const poNo = tr.getAttribute('data-pono');
          document.getElementById('salePoNo').value = poNo;
          renderPoPickerDetail(poNo);
        };
      });
    }

    function renderPoPickerDetail(poNo) {
      const detail = document.getElementById('poPickerDetail');
      const rows = poMaster.filter(po => po.poNo === poNo);
      detail.innerHTML = rows.map(po => `
    <tr class="border-b">
      <td class="px-2 py-1">${po.product}</td>
      <td class="px-2 py-1 text-right">${po.qty}</td>
      <td class="px-2 py-1 text-right">${po.amount.toLocaleString('ko-KR')}</td>
    </tr>
  `).join('') || `<tr><td colspan="3" class="text-center text-gray-400 py-3">í•­ëª© ì—†ìŒ</td></tr>`;
    }
    /* =============================
       ìˆ˜ì…ì—…ë¬´: í–‰ ì¶”ê°€ + ê³„ì‚° + ì €ì¥
       ============================= */

    // ìˆ˜ì… í’ˆëª© í–‰ ì¶”ê°€
    function addImportRow() {
      const tbody = document.getElementById('importItemsBody');
      if (!tbody) return;

      const tr = document.createElement('tr');
      tr.innerHTML = `
    <td><input class="border rounded-xl px-2 py-1 w-full import-product" /></td>
    <td><input class="border rounded-xl px-2 py-1 w-full import-product-code" /></td>
    <td><input class="border rounded-xl px-2 py-1 w-full import-hscode" /></td>
    <td><input class="border rounded-xl px-2 py-1 w-full import-origin" /></td>
    <td><input type="number" class="border rounded-xl px-2 py-1 w-24 text-right import-unit-price" /></td>
    <td><input type="number" class="border rounded-xl px-2 py-1 w-20 text-right import-qty" /></td>
    <td class="text-right px-2 import-amount">0</td>
    <td><input type="number" class="border rounded-xl px-2 py-1 w-20 text-right import-cbm" /></td>
    <td><input type="number" class="border rounded-xl px-2 py-1 w-20 text-right import-gw" /></td>
    <td><input type="number" class="border rounded-xl px-2 py-1 w-20 text-right import-nw" /></td>
    <td class="text-right px-2 import-alloc-freight">0</td>
    <td class="text-right px-2 import-alloc-local">0</td>
    <td class="text-right px-2 import-final-unit">0</td>
    <td><button type="button" class="text-red-500 text-sm btnDel">âœ•</button></td>
  `;

      tr.querySelector('.btnDel').onclick = () => {
        tr.remove();
        updateImportSummary();
      };

      // ë‹¨ê°€, ìˆ˜ëŸ‰, CBM ë³€ê²½ ì‹œ ê¸ˆì•¡/ìš”ì•½ ê°±ì‹ 
      tr.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => {
          recalcImportTable();   // í–‰ë³„ ê³„ì‚°
          updateImportSummary(); // í•©ê³„ í…ìŠ¤íŠ¸
        });
      });

      tbody.appendChild(tr);
      updateImportSummary();
    }

    // í’ˆëª© í•©ê³„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    function updateImportSummary() {
      const tbody = document.getElementById('importItemsBody');
      const summaryEl = document.getElementById('importSummary');
      if (!tbody || !summaryEl) return;

      let totalQty = 0;
      let totalCBM = 0;
      let totalAmount = 0;

      tbody.querySelectorAll('tr').forEach(tr => {
        const qty = Number(tr.querySelector('.import-qty')?.value || 0);
        const cbm = Number(tr.querySelector('.import-cbm')?.value || 0);
        const amount = Number((tr.querySelector('.import-amount')?.textContent || '0').replace(/,/g, ''));

        totalQty += qty;
        totalCBM += cbm;
        totalAmount += amount;
      });

      summaryEl.textContent =
        `ì´ ìˆ˜ëŸ‰: ${totalQty.toLocaleString('ko-KR')} / ì´ CBM: ${totalCBM.toLocaleString('ko-KR')} / ì´ ê¸ˆì•¡: ${totalAmount.toLocaleString('ko-KR')}`;
    }

    // CBM ë¹„ìœ¨ ê¸°ì¤€ í–‰ë³„ ê³„ì‚° (ê¸ˆì•¡/ë°°ë¶€/ìµœì¢…ë‹¨ê°€)ë§Œ ìˆ˜í–‰
    function recalcImportTable() {
      const tbody = document.getElementById('importItemsBody');
      if (!tbody) return;

      const freight = Number(document.getElementById('importFreight')?.value || 0);
      const localCharges = Number(document.getElementById('importLocalCharges')?.value || 0);
      const dutyRate = Number(document.getElementById('importDutyRate')?.value || 0);
      const vatRate = Number(document.getElementById('importVatRate')?.value || 0);
      const exchangeRate = Number(document.getElementById('importRate')?.value || 0);

      const rows = [...tbody.querySelectorAll('tr')];
      if (!rows.length) return;

      let totalCBM = 0;
      rows.forEach(tr => {
        const cbm = Number(tr.querySelector('.import-cbm')?.value || 0);
        totalCBM += cbm;
      });
      if (!totalCBM) return;

      let totalInvoiceCost = 0;
      let totalDuty = 0;
      let totalVat = 0;

      rows.forEach(tr => {
        const unitPrice = Number(tr.querySelector('.import-unit-price')?.value || 0);
        const qty = Number(tr.querySelector('.import-qty')?.value || 0);
        const cbm = Number(tr.querySelector('.import-cbm')?.value || 0);

        const amount = unitPrice * qty;
        totalInvoiceCost += amount;
        tr.querySelector('.import-amount').textContent = amount.toLocaleString('ko-KR');

        const ratio = cbm / totalCBM;
        const allocFreight = freight * ratio;
        const allocLocal = localCharges * ratio;

        tr.querySelector('.import-alloc-freight').textContent = Math.round(allocFreight).toLocaleString('ko-KR');
        tr.querySelector('.import-alloc-local').textContent = Math.round(allocLocal).toLocaleString('ko-KR');

        const dutiableValue = amount * exchangeRate;
        const duty = dutiableValue * (dutyRate / 100);
        const vat = (dutiableValue + duty) * (vatRate / 100);

        totalDuty += duty;
        totalVat += vat;

        const finalUnitCost = qty ? (amount + allocFreight + allocLocal) / qty : 0;
        tr.querySelector('.import-final-unit').textContent = Math.round(finalUnitCost).toLocaleString('ko-KR');

        // í–‰ ê°ì²´ì— ê³„ì‚°ê°’ ì €ì¥ (ë‚˜ì¤‘ì— Notion ì €ì¥ìš©)
        tr._calcForNotion = {
          amount,
          allocFreight,
          allocLocal,
          duty,
          vat,
          finalUnitCost
        };
      });

      // í—¤ë” ìª½ ìš”ì•½ ìˆ«ì ì±„ìš°ê¸°
      const dutyRounded = Math.round(totalDuty);
      const vatRounded = Math.round(totalVat);
      const totalCost = Math.round(totalInvoiceCost + freight + localCharges + totalDuty + totalVat);

      const dutyAmtEl = document.getElementById('importDutyAmount');
      const vatAmtEl = document.getElementById('importVatAmount');
      const totalCostEl = document.getElementById('importTotalCost');

      if (dutyAmtEl) dutyAmtEl.value = dutyRounded;
      if (vatAmtEl) vatAmtEl.value = vatRounded;
      if (totalCostEl) totalCostEl.value = totalCost;
    }

    // ìˆ˜ì… ì €ì¥ ë²„íŠ¼
    async function saveImportEntry() {
      try {
        const tbody = document.getElementById('importItemsBody');
        const rows = [...tbody.querySelectorAll('tr')];
        if (!rows.length) {
          alert('í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }


        // ë¨¼ì € ê³„ì‚° ë°˜ì˜
        recalcImportTable();
        updateImportSummary();

        const date = document.getElementById('importDate').value || new Date().toISOString().slice(0, 10);

        // ImportNo ìë™ ìƒì„± (text)
        let importNoSpan = document.getElementById('importNo');
        const generatedNo = await generateImportNo(date);
        if (importNoSpan) importNoSpan.textContent = generatedNo;
        const importNo = generatedNo;

        const exporter = document.getElementById('importExporter').value.trim();
        const importer = document.getElementById('importImporter').value.trim();
        const forwarder = document.getElementById('importForwarder').value.trim();
        const transport = document.getElementById('importTransport').value.trim();
        const containerType = document.getElementById('importContainer').value.trim();
        const pol = document.getElementById('importPOL').value.trim();
        const pod = document.getElementById('importPOD').value.trim();
        const vessel = document.getElementById('importVessel').value.trim();
        const blMaster = document.getElementById('importBLMaster').value.trim();
        const blHouse = document.getElementById('importBLHouse').value.trim();
        const currency = document.getElementById('importCurrency').value.trim();
        const freight = Number(document.getElementById('importFreight').value || 0);
        const localCharges = Number(document.getElementById('importLocalCharges').value || 0);
        const dutyRate = Number(document.getElementById('importDutyRate').value || 0);
        const vatRate = Number(document.getElementById('importVatRate').value || 0);
        const exchangeRate = Number(document.getElementById('importRate').value || 0);
        const clearanceDate = document.getElementById('importClearanceDate').value || null;
        const dutyAmount = Number(document.getElementById('importDutyAmount').value || 0);
        const vatAmount = Number(document.getElementById('importVatAmount').value || 0);
        const totalCost = Number(document.getElementById('importTotalCost').value || 0);

        // 1) Master DB ì €ì¥
        await notionCreate(DB_IMPORT_MASTER, {
          ImportNo: rt(importNo),
          Date: dateISO(date),
          Exporter: rt(exporter),
          Importer: rt(importer),
          Forwarder: rt(forwarder),
          TransportType: rt(transport),
          ContainerType: rt(containerType),
          POL: rt(pol),
          POD: rt(pod),
          VesselVoyage: rt(vessel),
          BLNoMaster: rt(blMaster),
          BLNoHouse: rt(blHouse),
          Currency: select(currency),

          DutyExchangeRate: num(exchangeRate),
          Freight: num(freight),
          LocalCharges: num(localCharges),

          DutyRate: num(dutyRate),
          VATRate: num(vatRate),
          DutyAmount: num(dutyAmount),
          VATAmount: num(vatAmount),
          TotalCost: num(totalCost),

          ClearanceDate: clearanceDate ? dateISO(clearanceDate) : undefined
        });

        // 2) Items DB ì €ì¥
        for (const tr of rows) {
          const productName = tr.querySelector('.import-product')?.value.trim() || '';
          const productCode = tr.querySelector('.import-product-code')?.value.trim() || '';
          const hsCode = tr.querySelector('.import-hscode')?.value.trim() || '';
          const origin = tr.querySelector('.import-origin')?.value.trim() || '';
          const unitPrice = Number(tr.querySelector('.import-unit-price')?.value || 0);
          const qty = Number(tr.querySelector('.import-qty')?.value || 0);
          const cbm = Number(tr.querySelector('.import-cbm')?.value || 0);
          const gw = Number(tr.querySelector('.import-gw')?.value || 0);
          const nw = Number(tr.querySelector('.import-nw')?.value || 0);

          if (!productName && !productCode) continue;

          const calc = tr._calcForNotion || {
            amount: unitPrice * qty,
            allocFreight: 0,
            allocLocal: 0,
            duty: 0,
            vat: 0,
            finalUnitCost: 0
          };

          await notionCreate(DB_IMPORT_ITEMS, {
            ImportNo: rt(importNo),
            Product: rt(productName),
            ProductCode: rt(productCode),
            HSCode: rt(hsCode),
            Origin: rt(origin),

            UnitPrice: num(unitPrice),
            Qty: num(qty),
            Amount: num(calc.amount),
            CBM: num(cbm),
            GW: num(gw),
            NW: num(nw),

            AllocFreight: num(calc.allocFreight),
            AllocLocal: num(calc.allocLocal),

            DutyRate: num(dutyRate),
            DutyAmount: num(calc.duty),
            VATRate: num(vatRate),
            VATAmount: num(calc.vat),

            FinalUnitCost: num(calc.finalUnitCost),
            FinalTotalCost: num(calc.finalUnitCost * qty)
          });
        }

        const msg = document.getElementById('importMsg');
        if (msg) {
          msg.classList.remove('hidden');
          setTimeout(() => msg.classList.add('hidden'), 2000);
        }

        const btnPrintImport = document.getElementById('btnPrintImport');
        if (btnPrintImport) btnPrintImport.classList.remove('hidden');

        alert('ìˆ˜ì… ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        console.error(err);
        alert('ìˆ˜ì… ì €ì¥ ì˜¤ë¥˜: ' + err.message);
      }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    const btnAddImportItem = document.getElementById('btnAddImportItem');
    if (btnAddImportItem) {
      btnAddImportItem.addEventListener('click', addImportRow);
    }

    const btnSaveImport = document.getElementById('btnSaveImport');
    if (btnSaveImport) {
      btnSaveImport.addEventListener('click', saveImportEntry);
    }
    // =============================
    // â‘  ì™¸ë¶€ í…œí”Œë¦¿ ë¡œë”
    // =============================
    async function loadImportTemplate() {
      const res = await fetch('templates/import.html');
      return await res.text();
    }
    // =============================
    // â‘¡ í…œí”Œë¦¿ì— ë°ì´í„° ì‚½ì…
    // =============================
    function fillImportTemplate(template, master, items) {
      template = template.replace('{{ImportNo}}', master.ImportNo?.rich_text?.[0]?.plain_text || '');
      template = template.replace('{{Date}}', master.Date?.date?.start || '');
      template = template.replace('{{Exporter}}', master.Exporter?.rich_text?.[0]?.plain_text || '');
      template = template.replace('{{Importer}}', master.Importer?.rich_text?.[0]?.plain_text || '');
      template = template.replace('{{Forwarder}}', master.Forwarder?.rich_text?.[0]?.plain_text || '');
      template = template.replace('{{VesselVoyage}}', master.VesselVoyage?.rich_text?.[0]?.plain_text || '');
      template = template.replace('{{BLNoMaster}}', master.BLNoMaster?.rich_text?.[0]?.plain_text || '');
      template = template.replace('{{BLNoHouse}}', master.BLNoHouse?.rich_text?.[0]?.plain_text || '');
      template = template.replace('{{ClearanceDate}}', master.ClearanceDate?.date?.start || '');

      template = template.replace('{{Freight}}', master.Freight?.number || 0);
      template = template.replace('{{LocalCharges}}', master.LocalCharges?.number || 0);
      template = template.replace('{{DutyAmount}}', master.DutyAmount?.number || 0);
      template = template.replace('{{VATAmount}}', master.VATAmount?.number || 0);
      template = template.replace('{{TotalCost}}', master.TotalCost?.number || 0);

      // í’ˆëª© í…Œì´ë¸”
      let rows = '';
      items.forEach(it => {
        rows += `
      <tr>
        <td>${it.Product?.rich_text?.[0]?.plain_text || ''}</td>
        <td>${it.ProductCode?.rich_text?.[0]?.plain_text || ''}</td>
        <td>${it.HSCode?.rich_text?.[0]?.plain_text || ''}</td>
        <td>${it.Qty?.number || ''}</td>
        <td>${it.CBM?.number || ''}</td>
        <td>${it.UnitPrice?.number || ''}</td>
        <td>${it.FinalUnitCost?.number || ''}</td>
        <td>${it.FinalTotalCost?.number || ''}</td>
      </tr>`;
      });

      template = template.replace('{{ITEM_ROWS}}', rows);
      return template;
    }
    // =============================
    // â‘¢ ìˆ˜ì…ì„œ ì¶œë ¥ ë²„íŠ¼ ì´ë²¤íŠ¸
    // =============================
    document.getElementById("btnPrintImport").addEventListener("click", async () => {
      const importNo = document.getElementById("importNo").textContent.trim();
      if (!importNo) {
        alert("ë¨¼ì € ìˆ˜ì… ë‚´ìš©ì„ ì €ì¥í•˜ì„¸ìš”.");
        return;
      }

      // 1) MASTER ì¡°íšŒ
      const masterRes = await notionQuery(DB_IMPORT_MASTER, {
        filter: { property: "ImportNo", rich_text: { equals: importNo } }
      });
      if (!masterRes.results.length) {
        alert("ìˆ˜ì… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const master = masterRes.results[0].properties;

      // 2) ITEMS ì¡°íšŒ
      const itemsRes = await notionQuery(DB_IMPORT_ITEMS, {
        filter: { property: "ImportNo", rich_text: { equals: importNo } }
      });
      const items = itemsRes.results.map(r => r.properties);

      // 3) ì™¸ë¶€ í˜ì´ì§€ë¡œ ë„˜ê¸¸ payload ìƒì„±
      const payload = { master, items };

      // 4) ìˆ˜ì…ì„œ ì¶œë ¥ í˜ì´ì§€ë¡œ ì´ë™ (â­ ë°œì£¼ì„œ/ê²¬ì ì„œì™€ ë™ì¼ íŒ¨í„´)
      const url =
        `templates/import.html?data=${encodeURIComponent(JSON.stringify(payload))}`;

      window.open(url, "_blank");
    });

    // =============================
    // â˜… ìˆ˜ì…ì„œ ì¶œë ¥ ê¸°ëŠ¥
    // =============================
    const btnPrintImport = document.getElementById('btnPrintImport');
    if (btnPrintImport) {
      btnPrintImport.addEventListener("click", async () => {

        const importNo = document.getElementById("importNo").textContent.trim();
        if (!importNo || importNo === "ìë™ìƒì„±ë¨") {
          alert("ë¨¼ì € ìˆ˜ì… ë‚´ìš©ì„ ì €ì¥í•˜ì„¸ìš”.");
          return;
        }

        // 1) MASTER ì¡°íšŒ
        const masterRes = await notionQuery(DB_IMPORT_MASTER, {
          filter: { property: "ImportNo", rich_text: { equals: importNo } }
        });
        if (!masterRes.results.length) {
          alert("ìˆ˜ì… ê¸°ë³¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const master = masterRes.results[0].properties;

        // 2) ITEMS ì¡°íšŒ
        const itemsRes = await notionQuery(DB_IMPORT_ITEMS, {
          filter: { property: "ImportNo", rich_text: { equals: importNo } }
        });
        const items = itemsRes.results.map(r => r.properties);

        // 3) Payload ë§Œë“¤ê¸°
        const payload = { master, items };

        // 4) ì™¸ë¶€ í˜ì´ì§€ë¡œ ì´ë™ (â˜…í•µì‹¬)
        const url =
          `templates/import.html?data=${encodeURIComponent(JSON.stringify(payload))}`;

        window.open(url, "_blank");
      });
    }



    (async () => {
      const ok = await restoreSession();
      if (ok) {
        ui.showApp(currentUser.Email);
        await loadClients();
        await loadProductCodes();
        await preloadProductMaster();
        applySaleTypeRule();
        addQuoteRow({});
        await runSalesSearch();
        await loadDashboard(); // ì„¸ì…˜ ë³µì› ì‹œ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
      }
    })();

    async function loadProductsFull() {
      const d = await notionQuery(DB_PRODUCTS, {
        sorts: [{ property: 'ProductCode', direction: 'ascending' }],
        page_size: 1000
      });

      window.productList = d.results.map(r => {
        const p = r.properties;
        return {
          code: p.ProductCode?.rich_text?.[0]?.plain_text || '',
          category: p.Category?.rich_text?.[0]?.plain_text || '',
          name: p.ProductName?.rich_text?.[0]?.plain_text || '',
          maker: p.Maker?.rich_text?.[0]?.plain_text || '',
          client: p.Supplier?.rich_text?.[0]?.plain_text || '',
          cost: p.Cost?.number ?? '',
          inputA: p.InputA?.rich_text?.[0]?.plain_text || '',
          outputV: p.OutputV?.rich_text?.[0]?.plain_text || '',
          outputA: p.OutputA?.rich_text?.[0]?.plain_text || '',
          material: p.Material?.rich_text?.[0]?.plain_text || '',
          size: p.Size?.rich_text?.[0]?.plain_text || '',
          converter: p.Converter?.rich_text?.[0]?.plain_text || '',
          detail: p.Detail?.rich_text?.[0]?.plain_text || '',
          fileSpec: p.FileSpec?.files?.[0]?.name || '',
          fileKSKC: p.FileKSKC?.files?.[0]?.name || '',
          fileEMI: p.FileEMI?.files?.[0]?.name || '',
          fileEfficiency: p.FileEfficiency?.files?.[0]?.name || '',
          fileEtc: p.FileEtc?.files?.[0]?.name || ''
        };
      });
    }
    function renderProductList() {
      const tbody = document.getElementById("productListBody");
      tbody.innerHTML = "";

      productList.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td class="px-2 py-1">${p.code}</td>
      <td class="px-2 py-1">${p.category}</td>
      <td class="px-2 py-1">${p.name}</td>
      <td class="px-2 py-1">${p.maker}</td>
      <td class="px-2 py-1">${p.client}</td>
      <td class="px-2 py-1 text-right">${p.cost}</td>
      <td class="px-2 py-1">${p.inputA}</td>
      <td class="px-2 py-1">${p.outputV}</td>
      <td class="px-2 py-1">${p.outputA}</td>
      <td class="px-2 py-1">${p.material}</td>
      <td class="px-2 py-1">${p.size}</td>
      <td class="px-2 py-1">${p.converter}</td>
      <td class="px-2 py-1">${p.detail}</td>
      <td class="px-2 py-1">${p.fileSpec}</td>
      <td class="px-2 py-1">${p.fileKSKC}</td>
      <td class="px-2 py-1">${p.fileEMI}</td>
      <td class="px-2 py-1">${p.fileEfficiency}</td>
      <td class="px-2 py-1">${p.fileEtc}</td>
    `;
        tbody.appendChild(tr);
      });
    }

    async function loadClientsFull() {
      const d = await notionQuery(DB_CLIENTS, {
        sorts: [{ property: 'ClientName', direction: 'ascending' }],
        page_size: 1000
      });

      window.clientList = d.results.map(r => {
        const p = r.properties;

        return {
          id: r.id,  // â˜… Notion pageId ì¶”ê°€

          name: p.ClientName?.title?.[0]?.plain_text || '',
          type: p.ClientType?.select?.name || '',
          ceo: p.CEO?.rich_text?.[0]?.plain_text || '',
          bizNo: p.BusinessNo?.rich_text?.[0]?.plain_text || '',
          industry: p.Industry?.rich_text?.[0]?.plain_text || '',
          address: p.Address?.rich_text?.[0]?.plain_text || '',
          address2: p.Address2?.rich_text?.[0]?.plain_text || '',
          tel: p.Tel?.rich_text?.[0]?.plain_text || '',
          fax: p.Fax?.rich_text?.[0]?.plain_text || '',
          email: p.Email?.email || '',
          currency: p.Currency?.select?.name || '',
          bank: p.Bank?.rich_text?.[0]?.plain_text || '',
          accountNo: p.AccountNo?.rich_text?.[0]?.plain_text || '',
          accountHolder: p.AccountHolder?.rich_text?.[0]?.plain_text || '',
          taxType: p.TaxType?.select?.name || '',
          status: p.Status?.select?.name || '',
          regDate: p.RegDate?.date?.start || '',
          bizFile: p.BizFile?.files?.[0]?.name || '',
          bankFile: p.BankFile?.files?.[0]?.name || ''
        };
      });

    }
    function renderClientListFull() {
      const tbody = document.getElementById("clientListBody");
      tbody.innerHTML = "";

      (window.clientList || []).forEach(c => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
      <td class="px-2 py-1">${c.name}</td>
      <td class="px-2 py-1">${c.type}</td>
      <td class="px-2 py-1">${c.ceo}</td>
      <td class="px-2 py-1">${c.bizNo}</td>
      <td class="px-2 py-1">${c.industry}</td>
      <td class="px-2 py-1">${c.address}</td>
      <td class="px-2 py-1">${c.address2}</td>
      <td class="px-2 py-1">${c.tel}</td>
      <td class="px-2 py-1">${c.fax}</td>
      <td class="px-2 py-1">${c.email}</td>
      <td class="px-2 py-1">${c.currency}</td>
      <td class="px-2 py-1">${c.bank}</td>
      <td class="px-2 py-1">${c.accountNo}</td>
      <td class="px-2 py-1">${c.accountHolder}</td>
      <td class="px-2 py-1">${c.taxType}</td>
      <td class="px-2 py-1">${c.status}</td>
      <td class="px-2 py-1">${c.regDate}</td>
      <td class="px-2 py-1">${c.bizFile}</td>
      <td class="px-2 py-1">${c.bankFile}</td>
      <!-- â˜… ìˆ˜ì • ë²„íŠ¼ -->
      <td class="px-2 py-1">
        <button type="button"
                class="text-xs text-blue-600 underline"
                data-id="${c.id}">
          ìˆ˜ì •
        </button>
      </td>
    `;
        tbody.appendChild(tr);
      });

      // â˜… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
      tbody.querySelectorAll('button[data-id]').forEach(btn => {
        btn.onclick = () => startEditClient(btn.dataset.id);
      });
    }


    document.getElementById("btnPickExporter").onclick = () => {
      currentPickingClientFor = "exporter";
      openClientPicker();
    };
    document.getElementById("btnPickImporter").onclick = () => {
      currentPickingClientFor = "importer";
      openClientPicker();
    };
    document.getElementById("btnPickForwarder").onclick = () => {
      currentPickingClientFor = "forwarder";
      openClientPicker();
    };

    function startEditClient(id) {
      const c = (window.clientList || []).find(x => x.id === id);
      if (!c) {
        alert('ê±°ë˜ì²˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // 1) í¼ì— ê°’ ì±„ìš°ê¸°
      document.getElementById('cName').value = c.name || '';
      document.getElementById('cType').value = c.type || '';
      document.getElementById('cCEO').value = c.ceo || '';
      document.getElementById('cBizNo').value = c.bizNo || '';
      document.getElementById('cIndustry').value = c.industry || '';
      document.getElementById('cAddress').value = c.address || '';
      document.getElementById('cAddress2').value = c.address2 || '';
      document.getElementById('cTel').value = c.tel || '';
      document.getElementById('cFax').value = c.fax || '';
      document.getElementById('cEmail').value = c.email || '';
      document.getElementById('cCurrency').value = c.currency || 'KRW';
      document.getElementById('cBank').value = c.bank || '';
      document.getElementById('cAccountNo').value = c.accountNo || '';
      document.getElementById('cAccountHolder').value = c.accountHolder || '';
      document.getElementById('cTaxType').value = c.taxType || 'í¬í•¨';
      document.getElementById('cStatus').value = c.status || 'ì •ìƒ';
      document.getElementById('cRegDate').value = c.regDate || '';

      // íŒŒì¼ ì…ë ¥ì€ ë³´ì•ˆ ë•Œë¬¸ì— ê°’ì„ ë¯¸ë¦¬ ë„£ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ê·¸ëŒ€ë¡œ ë¹„ì›Œë‘ê¸°)

      // 2) ì§€ê¸ˆ ìˆ˜ì • ì¤‘ì¸ pageId ê¸°ì–µ
      editingClientId = id;

      // 3) ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ "ìˆ˜ì •" ëŠë‚Œìœ¼ë¡œ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ (ì„ íƒ)
      const btn = document.getElementById('btnSaveClient');
      if (btn) btn.textContent = 'ê±°ë˜ì²˜ ìˆ˜ì • ì €ì¥';

      // 4) í™”ë©´ì„ ìœ„ë¡œ ì˜¬ë ¤ í¼ì´ ë³´ì´ê²Œ (ì„ íƒ)
      document.getElementById('tab-clients')?.scrollIntoView({ behavior: 'smooth' });
    }

    /* ===============================
       ê±°ë˜ì²˜ ì„ íƒ ë²„íŠ¼ â†’ ëª¨ë‹¬ ì—´ê¸°
    ==================================*/
    function openClientPicker(targetInputId) {
      currentPickingClientFor = targetInputId;

      // ê¸°ì¡´ ê²€ìƒ‰ ì´ˆê¸°í™”
      document.getElementById("modalClientSearch").value = "";

      // ëª¨ë‹¬ í‘œì‹œ
      document.getElementById("modalClients").classList.remove("hidden");

      // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
      renderClientModalList();
    }

    /* ëª¨ë‹¬ ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ */
    function renderClientModalList(keyword = "") {
      const box = document.getElementById("modalClientList");
      box.innerHTML = "";

      const filtered = clients.filter(c =>
        c.name.includes(keyword) ||
        c.bizNo.includes(keyword) ||
        c.ceo.includes(keyword)
      );

      filtered.forEach(c => {
        const div = document.createElement("div");
        div.className = "p-2 border rounded cursor-pointer hover:bg-gray-100";
        div.textContent = c.name;
        div.onclick = () => {
          document.getElementById(currentPickingClientFor).value = c.name;
          document.getElementById("modalClients").classList.add("hidden");
        };
        box.appendChild(div);
      });
    }

    document.getElementById("modalClientSearch").oninput = (e) =>
      renderClientModalList(e.target.value);

    document.getElementById("btnCloseClients").onclick = () =>
      document.getElementById("modalClients").classList.add("hidden");


    /* ===============================
       ê° ë²„íŠ¼ì— ëª¨ë‹¬ ì—°ê²°
    ==================================*/
    document.getElementById("btnPickClient").onclick = () =>
      openClientPicker("saleCustomer");

    document.getElementById("btnPickClientSearch").onclick = () =>
      openClientPicker("sCustomer");

    document.getElementById("btnPickClientQuote").onclick = () =>
      openClientPicker("quoteClient");

    document.getElementById("btnPickClientQuoteSearch").onclick = () =>
      openClientPicker("qsClient");

    document.getElementById("btnPickClientPo").onclick = () =>
      openClientPicker("poSupplier");

    document.getElementById("btnPickClientPoSearch").onclick = () =>
      openClientPicker("psSupplier");

    /* ìˆ˜ì…ì—…ë¬´ */
    document.getElementById("btnPickExporter").onclick = () =>
      openClientPicker("importExporter");

    document.getElementById("btnPickImporter").onclick = () =>
      openClientPicker("importImporter");

    document.getElementById("btnPickForwarder").onclick = () =>
      openClientPicker("importForwarder");

    /* ============================
       ë°œì£¼ë²ˆí˜¸ ìƒì„± í•¨ìˆ˜ (ì •í™• ë²„ì „)
       ì˜ˆ: PO20250211-001
    ============================ */
    function generatePoNo() {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");

      const ymd = `${y}${m}${d}`;

      // localStorageì— ë‚ ì§œë³„ ì‹œí€€ìŠ¤ ì €ì¥
      const key = `po_seq_${ymd}`;
      let seq = Number(localStorage.getItem(key) || 0) + 1;
      localStorage.setItem(key, seq);

      return `PO${ymd}-${String(seq).padStart(3, "0")}`;
    }


  </script>

  <!-- Chart.js ë¡œë”© -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- fx.js ì´ˆê¸°í™” -->
  <script type="module">
    import { initFxController } from "./fx.js";
    initFxController();
  </script>
  <script type="module">
    import { initFxController } from "./fx.js";
    import { initLmeController } from "./lme.js";

    initFxController();
    initLmeController();
  </script>

</body>

</html>